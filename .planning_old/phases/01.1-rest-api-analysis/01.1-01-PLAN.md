---
phase: 01.1-rest-api-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/01.1-rest-api-analysis/API-AUDIT-REPORT.md
  - .planning/phases/01.1-rest-api-analysis/REST-COMPLIANCE-MATRIX.md
  - .planning/phases/01.1-rest-api-analysis/STANDARDIZATION-RECOMMENDATIONS.md
autonomous: true
requirements: []

must_haves:
  truths:
    - "Every API endpoint in frontend/src/app/api/ is catalogued with its HTTP methods, path, auth pattern, request/response shape, and error format"
    - "Each endpoint has a Richardson Maturity Level assessment (0-2) with specific justification"
    - "Auth inconsistencies are documented per-endpoint with current mechanism and recommended standard"
    - "Three distinct error shapes in the codebase are identified with exact file locations"
    - "Breaking vs. non-breaking changes are classified for every standardization recommendation"
  artifacts:
    - path: ".planning/phases/01.1-rest-api-analysis/API-AUDIT-REPORT.md"
      provides: "Complete endpoint inventory with HTTP method/path/compliance matrix for all 28+ endpoints"
      contains: "| Domain | Path | Methods |"
    - path: ".planning/phases/01.1-rest-api-analysis/REST-COMPLIANCE-MATRIX.md"
      provides: "Per-endpoint Richardson Model assessment across 6 REST dimensions"
      contains: "| Endpoint Group | HTTP Verbs | Resource Naming | Statelessness | Response Codes | Auth Standard | Severity |"
    - path: ".planning/phases/01.1-rest-api-analysis/STANDARDIZATION-RECOMMENDATIONS.md"
      provides: "Prioritized recommendations with breaking/non-breaking classification, auth migration strategy, error response standardization plan"
      contains: "## Breaking Changes"
  key_links:
    - from: "API-AUDIT-REPORT.md"
      to: "REST-COMPLIANCE-MATRIX.md"
      via: "Endpoint inventory feeds compliance assessment"
      pattern: "Every endpoint in audit appears in matrix"
    - from: "REST-COMPLIANCE-MATRIX.md"
      to: "STANDARDIZATION-RECOMMENDATIONS.md"
      via: "Compliance gaps drive recommendations"
      pattern: "Every FAIL/PARTIAL in matrix has a recommendation"
---

<objective>
Audit all REST API endpoints, assess each against RESTful best practices (Richardson Maturity Model Level 2), and produce standardization recommendations.

Purpose: Establish a complete, accurate picture of the current API surface before any refactoring begins. This audit drives all subsequent standardization work in Phase 1.1 and informs API design decisions in Phase 1+.

Output: Three documents — (1) API Audit Report with full endpoint inventory, (2) REST Compliance Matrix rating each endpoint on 6 dimensions, (3) Standardization Recommendations with breaking/non-breaking classification and auth migration strategy.
</objective>

<execution_context>
@/Users/arana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-rest-api-analysis/01.1-RESEARCH.md

Source files to audit (all API route handlers):
@frontend/src/app/api/health/route.ts
@frontend/src/app/api/openapi/route.ts
@frontend/src/app/api/agents/route.ts
@frontend/src/app/api/agents/[agentId]/route.ts
@frontend/src/app/api/agents/[agentId]/tasks/route.ts
@frontend/src/app/api/agents/[agentId]/tasks/[taskId]/route.ts
@frontend/src/app/api/agents/[agentId]/tasks/[taskId]/comments/route.ts
@frontend/src/app/api/agents/[agentId]/heartbeat/route.ts
@frontend/src/app/api/agents/[agentId]/poll/route.ts
@frontend/src/app/api/agents/[agentId]/rotate-key/route.ts
@frontend/src/app/api/agents/[agentId]/wiki/pages/route.ts
@frontend/src/app/api/agents/[agentId]/wiki/pages/[pageId]/route.ts
@frontend/src/app/api/agents/workspace/structure/route.ts
@frontend/src/app/api/tasks/[taskId]/route.ts
@frontend/src/app/api/tasks/execute/route.ts
@frontend/src/app/api/tasks/generate-daily/route.ts
@frontend/src/app/api/tasks/[taskId]/calendar-events/route.ts
@frontend/src/app/api/businesses/route.ts
@frontend/src/app/api/epics/route.ts
@frontend/src/app/api/calendar/events/route.ts
@frontend/src/app/api/calendar/events/[eventId]/route.ts
@frontend/src/app/api/calendar/slots/route.ts
@frontend/src/app/api/memory/route.ts
@frontend/src/app/api/memory/files/route.ts
@frontend/src/app/api/memory/context/route.ts
@frontend/src/app/api/gateway/[gatewayId]/route.ts
@frontend/src/app/api/state-engine/metrics/route.ts
@frontend/src/app/api/state-engine/decisions/route.ts
@frontend/src/app/api/state-engine/alerts/route.ts
@frontend/src/app/api/reports/route.ts
@frontend/src/app/api/admin/agents/setup-workspace/route.ts
@frontend/src/app/api/admin/migrations/agent-workspace-paths/route.ts

Supporting files:
@frontend/lib/utils/apiResponse.ts
@frontend/lib/validators/agentValidators.ts
@frontend/lib/validators/agentTaskValidators.ts
@frontend/lib/validators/agentWorkspaceValidators.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From frontend/lib/utils/apiResponse.ts:
```typescript
export interface ApiSuccessResponse<T> {
  success: true;
  data: T;
  timestamp?: number;
}

export interface ApiErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: unknown;
  };
  timestamp?: number;
}
```

Three error shapes to identify per the research:
- Shape A (standardized): `{ success: false, error: { code, message }, timestamp }` — used by agent routes
- Shape B (raw): `{ error: "string" }` — used by gateway, memory, reports
- Shape C (mixed): `{ success: false, error: "string" }` — used by businesses
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive API Audit Report</name>
  <files>.planning/phases/01.1-rest-api-analysis/API-AUDIT-REPORT.md</files>
  <action>
Read every route handler file listed in the context section above (all 32 files in frontend/src/app/api/). For each endpoint, extract and document:

1. **HTTP methods** exported (GET, POST, PATCH, PUT, DELETE)
2. **Full URL path** (e.g., `/api/agents/[agentId]/tasks`)
3. **Auth mechanism** — exactly how authentication is performed:
   - `Authorization: Bearer` header
   - Custom `agentId`/`agentKey` headers
   - `agentKey` query parameter
   - `apiKey` in request body
   - No auth
4. **Request body schema** — what Zod validator (if any) is used, or describe the raw shape
5. **Response format** — which of the three error shapes is used:
   - Shape A: `jsonResponse(successResponse(...))` / `handleApiError()`
   - Shape B: `Response.json({ error: "..." })`
   - Shape C: `Response.json({ success: false, error: "..." })`
6. **Status codes** returned (200, 201, 400, 401, 404, 500)
7. **Notable issues** — action discriminators, verb-style names, missing auth, filesystem access

Create the audit report as a Markdown document at the specified path with:
- Title and date
- Summary statistics (total endpoints, auth breakdown, error shape breakdown)
- Full endpoint inventory table with columns: Domain, Path, Methods, Auth Mechanism, Request Validation, Response Format, Status Codes, Issues
- Detailed per-domain sections with findings for each endpoint group
- Special attention to: gateway ?action= anti-pattern (list all 7 actions), task action discriminator (list all 8 sub-operations), admin endpoints without auth

Do NOT copy the research findings verbatim. Read the actual source files and document what you find. The research is a guide, not a source of truth — the code is.
  </action>
  <verify>
    <automated>grep -c "| " .planning/phases/01.1-rest-api-analysis/API-AUDIT-REPORT.md | awk '{if ($1 >= 30) print "PASS: ",$1," table rows"; else print "FAIL: only ",$1," table rows (need 30+)"}'</automated>
  </verify>
  <done>
- Every route handler file in frontend/src/app/api/ is represented in the audit
- Each endpoint has all 7 data points documented (methods, path, auth, request validation, response format, status codes, issues)
- Summary statistics are accurate and derived from the table, not estimated
- Gateway ?action= pattern has all 7 sub-operations listed
- Task action discriminator has all 8 sub-operations listed
- Admin endpoints flagged for missing auth
  </done>
</task>

<task type="auto">
  <name>Task 2: Create REST Compliance Matrix and Standardization Recommendations</name>
  <files>
    .planning/phases/01.1-rest-api-analysis/REST-COMPLIANCE-MATRIX.md
    .planning/phases/01.1-rest-api-analysis/STANDARDIZATION-RECOMMENDATIONS.md
  </files>
  <action>
**Part A: REST Compliance Matrix**

Using the audit report from Task 1, create a compliance matrix assessing each endpoint group against 6 REST dimensions. For each endpoint group, rate as PASS, PARTIAL, or FAIL with a one-line justification:

1. **HTTP Verb Correctness** — GET for reads, POST for creates, PATCH/PUT for updates, DELETE for removes. FAIL if verbs are misused or operations are tunneled through wrong verb.
2. **Resource Naming** — URLs are nouns (not verbs), plural, hierarchical. FAIL if URL contains a verb (e.g., `/execute`, `/generate-daily`) or uses action params (`?action=`).
3. **Statelessness** — Each request contains all information needed. FAIL if server-side filesystem state is required (e.g., `/api/memory` reading `~/.openclaw/`).
4. **Response Codes** — Correct HTTP status codes (201 for create, 204 for delete, 400 for validation, 401 for auth, 404 for not found). PARTIAL if using generic 200 for creates.
5. **Auth Standard** — Uses `Authorization: Bearer` per RFC 6750. FAIL if custom headers, query params, or body auth. N/A if endpoint requires no auth.
6. **Error Consistency** — Uses Shape A (`{ success, error: { code, message } }`). FAIL if Shape B or C.

Rate overall severity per endpoint group: CRITICAL (Level 0-1 violations), HIGH (auth or error inconsistency), MEDIUM (naming or code issues), LOW (minor), None (compliant).

Reference the research compliance matrix (01.1-RESEARCH.md "RESTful Compliance Matrix" section) as a baseline, but VERIFY against the actual audit data from Task 1.

**Part B: Standardization Recommendations**

Create a recommendations document organized as:

1. **Non-Breaking Changes (Safe to deploy immediately)**
   For each recommendation: what to change, which files affected, effort estimate (Low/Medium/High), and implementation notes.

   Expected non-breaking items (verify against audit):
   - Add `zod-openapi` annotations to existing validators (additive metadata)
   - Replace hand-written `lib/openapi-generator.ts` with zod-openapi generation
   - Standardize error shape in gateway/memory/reports/businesses routes to Shape A
   - Add pagination `meta` to list endpoints
   - Add `X-Request-Id` header via middleware

2. **Breaking Changes (Require coordinated cutover)**
   For each recommendation: what breaks, who is affected (agent clients, UI), migration strategy (grace period or atomic cutover), and recommended timeline.

   Expected breaking items (verify against audit):
   - Auth header standardization: `agentId`/`agentKey` headers -> `Authorization: Bearer`
   - Gateway sub-route decomposition: `?action=` -> separate route files
   - Task URL renames: `/execute` -> `/executions`, `/generate-daily` -> `/daily-batches`

3. **Auth Migration Strategy**
   - List every endpoint currently using non-standard auth (from audit)
   - Describe two-phase migration: (a) accept both old and new auth for 2 weeks, (b) remove old form
   - Note which endpoints already use Bearer correctly (calendar routes, rotate-key)
   - Provide code pattern for the grace-period auth extraction function

4. **Error Response Standardization Plan**
   - List every route using Shape B or C (from audit)
   - For each: the current error code and what `handleApiError()` call should replace it
   - Note that `handleApiError()` from `lib/utils/apiResponse.ts` already exists and just needs consistent usage

5. **Deferred Recommendations**
   - API versioning (defer: no external consumers yet)
   - HATEOAS / Level 3 (defer: no benefit for agent clients)
   - Memory endpoint filesystem -> DB migration (defer: architecture change, separate phase)

6. **Priority Matrix**
   Table with columns: Change, Type (breaking/non-breaking), Priority (CRITICAL/HIGH/MEDIUM/LOW), Effort (Low/Medium/High), Recommended Phase
  </action>
  <verify>
    <automated>test -f .planning/phases/01.1-rest-api-analysis/REST-COMPLIANCE-MATRIX.md && test -f .planning/phases/01.1-rest-api-analysis/STANDARDIZATION-RECOMMENDATIONS.md && echo "PASS: Both files exist" || echo "FAIL: Missing files"</automated>
  </verify>
  <done>
- REST Compliance Matrix covers every endpoint group from the audit with ratings across all 6 dimensions
- Every FAIL or PARTIAL rating has a corresponding recommendation in the Standardization Recommendations
- Breaking changes list matches actual audit findings (not copied from research without verification)
- Auth migration strategy lists all endpoints with non-standard auth by exact path
- Error standardization plan lists all routes using Shape B or C by exact file path
- Priority matrix has every recommendation with type, priority, effort, and recommended phase
- Deferred items clearly separated from actionable recommendations
  </done>
</task>

</tasks>

<verification>
1. API-AUDIT-REPORT.md exists and contains a table with 28+ endpoint rows
2. REST-COMPLIANCE-MATRIX.md exists and contains ratings for every endpoint group across 6 dimensions
3. STANDARDIZATION-RECOMMENDATIONS.md exists and contains breaking/non-breaking classification, auth migration strategy, and error standardization plan
4. Every FAIL in the compliance matrix has a corresponding entry in the recommendations
5. All three documents are internally consistent (same endpoint counts, same issue classifications)
</verification>

<success_criteria>
1. A developer reading only these three documents can understand: (a) what every API endpoint does, (b) where it falls short of REST Level 2, and (c) what specific changes are needed
2. The audit is derived from actual source code inspection, not assumptions
3. Breaking changes are clearly separated from non-breaking changes with migration strategies
4. The recommendations are concrete enough to be turned into implementation tasks in Phase 1+
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-rest-api-analysis/01.1-01-SUMMARY.md`
</output>
