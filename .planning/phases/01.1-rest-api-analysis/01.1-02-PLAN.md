---
phase: 01.1-rest-api-analysis
plan: 02
type: execute
wave: 2
depends_on: ["01.1-01"]
files_modified:
  - frontend/lib/openapi/spec-generator.ts
  - frontend/lib/openapi/schemas.ts
  - frontend/lib/openapi/__tests__/spec-generator.test.ts
  - .planning/phases/01.1-rest-api-analysis/REFACTORING-ROADMAP.md
autonomous: true
requirements: []

must_haves:
  truths:
    - "Running the spec generator produces a valid OpenAPI 3.0 JSON document with all 28+ endpoints registered"
    - "The OpenAPI spec is generated from existing Zod validators in lib/validators/ — not hand-authored"
    - "The generated spec includes securitySchemes (BearerAuth), tags, error response schema, and pagination meta schema"
    - "A refactoring roadmap exists with concrete tasks for Phase 1+ organized by priority and effort"
    - "The test suite validates spec completeness by checking all known route paths appear in the generated spec"
  artifacts:
    - path: "frontend/lib/openapi/schemas.ts"
      provides: "Zod schemas annotated with .openapi() metadata for all API request/response types"
      contains: ".openapi("
    - path: "frontend/lib/openapi/spec-generator.ts"
      provides: "OpenAPI 3.0 spec generation using zod-openapi from annotated schemas"
      exports: ["generateOpenAPISpec"]
    - path: "frontend/lib/openapi/__tests__/spec-generator.test.ts"
      provides: "Tests verifying spec completeness and validity"
      contains: "describe"
    - path: ".planning/phases/01.1-rest-api-analysis/REFACTORING-ROADMAP.md"
      provides: "Prioritized task list for Phase 1+ API refactoring"
      contains: "## Phase"
  key_links:
    - from: "frontend/lib/openapi/schemas.ts"
      to: "frontend/lib/validators/agentValidators.ts"
      via: "Imports and extends existing Zod schemas with .openapi() metadata"
      pattern: "import.*from.*validators"
    - from: "frontend/lib/openapi/spec-generator.ts"
      to: "frontend/lib/openapi/schemas.ts"
      via: "Uses annotated schemas to build OpenAPI document"
      pattern: "import.*from.*schemas"
    - from: "frontend/lib/openapi/__tests__/spec-generator.test.ts"
      to: "frontend/lib/openapi/spec-generator.ts"
      via: "Tests the generated spec for completeness"
      pattern: "generateOpenAPISpec"
---

<objective>
Generate an OpenAPI 3.0 specification from existing Zod validators using `zod-openapi` (already installed at v5.4.6), and create an actionable refactoring roadmap for Phase 1+ API standardization.

Purpose: Replace the hand-written 1644-line `lib/openapi-generator.ts` with a code-first approach where Zod schemas are the single source of truth for both runtime validation and API documentation. The refactoring roadmap translates audit findings into prioritized implementation tasks.

Output: (1) OpenAPI schema definitions with .openapi() annotations on existing validators, (2) Spec generator that produces a valid OpenAPI 3.0 document, (3) Tests verifying spec completeness, (4) Refactoring roadmap for Phase 1+ implementation.
</objective>

<execution_context>
@/Users/arana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-rest-api-analysis/01.1-RESEARCH.md
@.planning/phases/01.1-rest-api-analysis/01.1-01-SUMMARY.md

Source files:
@frontend/lib/validators/agentValidators.ts
@frontend/lib/validators/agentTaskValidators.ts
@frontend/lib/validators/agentWorkspaceValidators.ts
@frontend/lib/openapi-generator.ts
@frontend/lib/utils/apiResponse.ts
@frontend/src/app/api/openapi/route.ts
@frontend/package.json

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From frontend/lib/validators/agentValidators.ts:
```typescript
export const RegisterAgentSchema = z.object({ name, role, level, sessionKey, workspacePath });
export const UpdateAgentSchema = z.object({ status, skills, config });
export const HeartbeatSchema = z.object({ agentId, agentKey, status, metrics });
export const AgentPollSchema = z.object({ agentKey, status });
export const RotateKeySchema = z.object({ currentKey? });  // Also accepts Authorization: Bearer
```

From frontend/lib/validators/agentTaskValidators.ts:
```typescript
export const AgentTaskListQuerySchema = z.object({ status?, priority?, sortBy?, sortOrder?, limit?, offset? });
export const AgentTaskUpdateSchema = z.object({ status?, progress?, result? });
```

From frontend/lib/validators/agentWorkspaceValidators.ts:
```typescript
export const SetupWorkspaceSchema = z.object({ agentId, workspacePath?, structure? });
```

From frontend/lib/utils/apiResponse.ts:
```typescript
export interface ApiSuccessResponse<T> { success: true; data: T; timestamp?: number; }
export interface ApiErrorResponse { success: false; error: { code: string; message: string; details?: unknown; }; timestamp?: number; }
export function successResponse<T>(data: T): ApiSuccessResponse<T>;
export function handleApiError(error: unknown, requestId?: string): Response;
export function jsonResponse(data: unknown, status?: number): Response;
```

From zod-openapi v5 (installed at ^5.4.6):
```typescript
import { extendZodWithOpenApi } from "zod-openapi";
import { createDocument } from "zod-openapi";
// extendZodWithOpenApi(z) adds .openapi() method to all Zod schemas
// createDocument() builds OpenAPI 3.0 document from schema definitions
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenAPI schema annotations and spec generator</name>
  <files>
    frontend/lib/openapi/schemas.ts
    frontend/lib/openapi/spec-generator.ts
    frontend/lib/openapi/__tests__/spec-generator.test.ts
  </files>
  <action>
**Step 1: Create `frontend/lib/openapi/schemas.ts`**

This file annotates existing Zod validators with OpenAPI metadata. It does NOT duplicate the validators — it imports them and extends with `.openapi()`.

```typescript
import { z } from "zod";
import { extendZodWithOpenApi } from "zod-openapi";

extendZodWithOpenApi(z);
```

For each existing validator in `lib/validators/`, import and extend:
- `RegisterAgentSchema` -> add `.openapi({ ref: "RegisterAgentRequest", ... })`
- `UpdateAgentSchema` -> add `.openapi({ ref: "UpdateAgentRequest", ... })`
- `HeartbeatSchema` -> add `.openapi({ ref: "HeartbeatRequest", ... })`
- `AgentPollSchema` -> add `.openapi({ ref: "AgentPollRequest", ... })`
- `AgentTaskListQuerySchema` -> add `.openapi({ ref: "AgentTaskListQuery", ... })`
- `AgentTaskUpdateSchema` -> add `.openapi({ ref: "AgentTaskUpdateRequest", ... })`

Also define schemas for types NOT yet in validators (derive from reading the actual route handler request/response shapes):
- `ErrorResponseSchema` — matches `ApiErrorResponse` from `lib/utils/apiResponse.ts`
- `PaginationMetaSchema` — `{ limit: number, offset: number, hasMore: boolean }`
- `SuccessResponseSchema` — generic wrapper `{ success: true, data: T, timestamp?: number }`
- Response schemas for each domain (AgentResponse, TaskResponse, etc.) — derive from what route handlers actually return

Add `.openapi()` examples to each schema (example values for documentation).

**IMPORTANT:** Read the `zod-openapi` v5 docs to confirm the exact API. The research notes that v5 changed from v4 — verify `.openapi()` method signatures and `createDocument()` usage before implementing. Use `extendZodWithOpenApi(z)` to patch Zod globally, then call `.openapi()` on schema instances.

**Step 2: Create `frontend/lib/openapi/spec-generator.ts`**

This file generates the complete OpenAPI 3.0 document.

Use `createDocument` from `zod-openapi` to build the spec:
- `info`: title "Mission Control API", version "1.0.0", description
- `servers`: `[{ url: "http://localhost:3000", description: "Development" }]`
- `tags`: Group by domain — Agents, Tasks, Gateway, Calendar, Memory, Admin, Health, State Engine, Reports, Epics, Businesses
- `components.securitySchemes`: Define `BearerAuth` as `{ type: "http", scheme: "bearer", description: "Agent API key" }`
- `paths`: Register every endpoint from the audit report (all 28+). For each:
  - Path and method
  - Operation ID (e.g., `registerAgent`, `getAgentTasks`)
  - Summary and description
  - Request body schema (reference annotated Zod schemas)
  - Response schemas for 200/201, 400, 401, 404, 500
  - Security requirement (which endpoints need BearerAuth, which are public)
  - Tags

Export a `generateOpenAPISpec()` function that returns the OpenAPI document as a JavaScript object.

The generated spec must include ALL endpoints found in the audit, including:
- The gateway endpoint (document current ?action= pattern as-is, since this plan is documentation, not refactoring)
- The task action discriminator endpoint (document the PATCH body shapes)
- Admin endpoints (note the missing auth in description)
- Memory endpoints (note the filesystem dependency in description)

**Step 3: Create test file `frontend/lib/openapi/__tests__/spec-generator.test.ts`**

Write tests that verify:
1. `generateOpenAPISpec()` returns a valid OpenAPI 3.0 object (has `openapi: "3.0.0"`, `info`, `paths`)
2. All known API paths are present in the generated spec (list all 28+ paths as test constants)
3. `components.securitySchemes.BearerAuth` exists
4. `components.schemas.ErrorResponse` exists and matches the expected shape
5. Each agent endpoint has a `security` field referencing BearerAuth
6. Public endpoints (health, openapi) do NOT have a security requirement
7. Response schemas reference `$ref` to components (not inline)
8. Tags cover all domains

Use Jest (the project's test framework per jest.config.js).

**NOTE on the existing `lib/openapi-generator.ts`:** Do NOT modify or delete this file in this plan. The new spec generator is a parallel implementation. The old generator will be deprecated in a future phase once the new generator is validated. Document in the spec-generator.ts header comment: "Replaces lib/openapi-generator.ts — see REFACTORING-ROADMAP.md for migration plan."
  </action>
  <verify>
    <automated>cd /Users/arana/dev/ankit/mission-control && npx jest --testPathPattern="openapi/.*spec-generator" --passWithNoTests 2>&1 | tail -5</automated>
  </verify>
  <done>
- `frontend/lib/openapi/schemas.ts` exists with imported validators extended with `.openapi()` metadata
- `frontend/lib/openapi/spec-generator.ts` exists with `generateOpenAPISpec()` function
- `frontend/lib/openapi/__tests__/spec-generator.test.ts` exists with tests for spec completeness
- All tests pass
- Generated spec includes all 28+ endpoints
- Generated spec has BearerAuth security scheme
- Generated spec has ErrorResponse schema in components
- The existing `lib/openapi-generator.ts` is NOT modified
  </done>
</task>

<task type="auto">
  <name>Task 2: Create actionable refactoring roadmap for Phase 1+</name>
  <files>.planning/phases/01.1-rest-api-analysis/REFACTORING-ROADMAP.md</files>
  <action>
Using the audit report (01.1-01-SUMMARY.md), compliance matrix, and standardization recommendations from Plan 01, create a concrete refactoring roadmap.

The roadmap must be structured as a prioritized task list that subsequent phases can directly consume. It is NOT a narrative document — it is a work breakdown.

**Structure:**

1. **Executive Summary** (2-3 paragraphs)
   - Current state: 28 endpoints, Richardson Level distribution, key anti-patterns
   - Target state: All endpoints at Richardson Level 2, standardized auth, consistent error shapes
   - Scope: What is covered (REST standardization) and what is deferred (HATEOAS, versioning)

2. **Phase 1 Recommendations (Data Foundation Integration)**
   Tasks that should be done alongside Phase 1 schema work because they affect the same files or establish patterns:
   - Error shape standardization (non-breaking, affects 6 routes)
   - Add `X-Request-Id` middleware (non-breaking, new file)
   - Wire new OpenAPI generator to `/api/openapi` route (non-breaking, replaces old generator)

3. **Phase 2 Recommendations (Workflow Definition)**
   Tasks that align with Phase 2 because they affect workflow-related endpoints:
   - Task URL renames (`/execute` -> `/executions`, `/generate-daily` -> `/daily-batches`) — coordinate with new workflow endpoints

4. **Phase 3 Recommendations (Execution Engine)**
   Tasks that must happen during Phase 3 because the gateway is redesigned:
   - Gateway sub-route decomposition (`?action=` -> 7 sub-routes)
   - Auth header standardization (batch with gateway refactor to minimize agent disruption)
   - Admin endpoint auth guards

5. **Deferred (Post-v1)**
   - API versioning (no external consumers)
   - HATEOAS / Level 3 (no benefit for agent clients)
   - Memory endpoint filesystem -> Convex migration

6. **Implementation Task Table**
   One row per concrete task with columns:

   | # | Task | Type | Priority | Effort | Breaking | Recommended Phase | Files Affected | Dependencies |
   |---|------|------|----------|--------|----------|-------------------|----------------|--------------|

   Include at minimum 15 tasks covering all recommendations from the standardization document.

7. **Migration Patterns**
   For each breaking change, describe the migration pattern:
   - **Auth migration**: Grace period pattern — `extractAuth(request)` function that accepts both old and new headers, logs deprecation warning for old format
   - **Gateway migration**: Parallel routes pattern — new sub-routes created alongside old `?action=` route, old route deprecated then removed
   - **URL migration**: Redirect pattern — old URLs return 301 to new URLs for 2 weeks

8. **Risk Assessment**
   - What could go wrong with each breaking change
   - Rollback strategy for each
   - Test requirements before cutover

Derive ALL content from the audit report, compliance matrix, and standardization recommendations created in Plan 01. Do not invent new findings — synthesize existing analysis into an actionable plan.
  </action>
  <verify>
    <automated>test -f .planning/phases/01.1-rest-api-analysis/REFACTORING-ROADMAP.md && grep -c "| " .planning/phases/01.1-rest-api-analysis/REFACTORING-ROADMAP.md | awk '{if ($1 >= 15) print "PASS: ",$1," table rows"; else print "FAIL: only ",$1," table rows (need 15+)"}'</automated>
  </verify>
  <done>
- REFACTORING-ROADMAP.md exists with all 8 sections
- Implementation task table has 15+ concrete tasks with all columns filled
- Every recommendation from STANDARDIZATION-RECOMMENDATIONS.md appears as a task
- Breaking changes have migration patterns described
- Tasks are assigned to recommended phases (1, 2, 3, or post-v1)
- Risk assessment covers all breaking changes
- The roadmap is actionable — a developer can read it and know exactly what to implement, in what order, and how to migrate
  </done>
</task>

</tasks>

<verification>
1. `frontend/lib/openapi/schemas.ts` exists with .openapi() annotations
2. `frontend/lib/openapi/spec-generator.ts` exports `generateOpenAPISpec()` that produces valid OpenAPI 3.0
3. `frontend/lib/openapi/__tests__/spec-generator.test.ts` tests pass
4. `REFACTORING-ROADMAP.md` exists with 15+ implementation tasks
5. The generated OpenAPI spec includes all endpoints found in the audit
6. The existing `lib/openapi-generator.ts` is untouched
7. Every recommendation from Plan 01's STANDARDIZATION-RECOMMENDATIONS.md appears in the roadmap
</verification>

<success_criteria>
1. The OpenAPI spec can be loaded in Swagger UI and renders all 28+ endpoints correctly
2. The spec is generated from Zod validators (single source of truth) — not hand-authored
3. The refactoring roadmap provides enough detail for a developer to create Jira/Linear tickets from it
4. All Phase 1.1 success criteria from the ROADMAP are satisfied across both plans
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-rest-api-analysis/01.1-02-SUMMARY.md`
</output>
