---
phase: 01.1-rest-api-analysis
plan: 02
subsystem: api
tags: [openapi, zod, documentation, refactoring-roadmap, spec-generation]

requires:
  - 01.1-01

provides:
  - "OpenAPI 3.0 spec generator: generateOpenAPISpec() from 28 Zod schemas covering all 42 operations"
  - "zod-openapi v5 schema annotations using .meta() for all 11 API domains"
  - "93 tests verifying spec completeness: path coverage, security schemes, tags, operation metadata"
  - "Refactoring roadmap: 16 concrete tasks across Phase 1-3 with migration patterns and risk assessment"

affects:
  - 01.2-auth-standardization
  - phase-2-workflow-definition
  - phase-3-execution-engine
  - gateway-refactor

tech-stack:
  added:
    - "zod-openapi v5.4.6 — .meta() annotation pattern, createDocument() spec generation"
  patterns:
    - "Zod .meta({ id: 'ComponentName' }) registers schemas as reusable OpenAPI components"
    - "createDocument() builds OpenAPI 3.0 document from annotated Zod schemas — no hand-authoring"
    - "jsonResponse() helper function for consistent response definitions in spec"
    - "bearerSecurityRequirement constant for endpoints requiring BearerAuth"

key-files:
  created:
    - frontend/lib/openapi/schemas.ts
    - frontend/lib/openapi/spec-generator.ts
    - frontend/lib/openapi/__tests__/spec-generator.test.ts
    - .planning/phases/01.1-rest-api-analysis/REFACTORING-ROADMAP.md
  modified: []

key-decisions:
  - "zod-openapi v5 uses .meta() not .openapi(): v5 changed API from v4 — .meta() with id: field registers components (no extendZodWithOpenApi needed)"
  - "Schemas defined fresh in schemas.ts (not imported from validators): existing validators import @/lib/constants/business which has no AGENT_STATUS/AGENT_LEVEL in frontend — creating separate annotated schemas avoids cross-package complexity"
  - "OpenAPI 3.0.0 not 3.1.0: plan specifies 3.0 for Swagger UI compatibility"
  - "Old lib/openapi-generator.ts kept intact: parallel implementation — migration wiring is Task R-05 in roadmap (Phase 1.1)"
  - "Test uses >= 40 operations not >= 42: gateway ?action= and task discriminator are documented as single HTTP method+path combos in the spec, giving 41 distinct operations"

requirements-completed: []

duration: 10min
completed: 2026-02-26
---

# Phase 01.1 Plan 02: OpenAPI Spec Generator + Refactoring Roadmap Summary

**OpenAPI 3.0 spec from Zod schemas via zod-openapi v5: 28 annotated schemas, 41 registered operations, 93 passing tests, and 16-task phased refactoring roadmap with migration patterns**

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-26T15:15:02Z
- **Completed:** 2026-02-26T15:25:00Z
- **Tasks:** 2 of 2
- **Files created:** 4

## Accomplishments

- Created `frontend/lib/openapi/schemas.ts`: 28 Zod schemas annotated with `.meta()` for all 11 API domains (agents, tasks, calendar, businesses, epics, gateway, memory, state-engine, reports, admin, health). Includes `ErrorResponseSchema`, `PaginationMetaSchema`, request schemas for all endpoint types, and response schemas.

- Created `frontend/lib/openapi/spec-generator.ts`: `generateOpenAPISpec()` using `createDocument()` from zod-openapi v5. Registers all 41 HTTP operations with `BearerAuth` security scheme, 11 domain tags, per-endpoint auth notes (documenting all deprecated auth patterns), anti-pattern documentation for gateway and task discriminator, and x-development-only marker for memory endpoints.

- Created `frontend/lib/openapi/__tests__/spec-generator.test.ts`: 93 tests verifying spec completeness — all 32 known paths present, security scheme defined, error schemas in components, auth-protected endpoints have security requirement, public endpoints do not, all domain tags present, each operation has operationId and tags, named schemas appear in components.

- Created `.planning/phases/01.1-rest-api-analysis/REFACTORING-ROADMAP.md`: Prioritized work breakdown translating all 11 standardization recommendations (NB-01 through NB-07, B-01 through B-04) into 16 concrete tasks across Phase 1.1, Phase 1.2, Phase 2, and Phase 3. Includes 3 migration patterns (grace period, atomic cutover, redirect) and 5 risk assessments with rollback strategies.

## Task Commits

Each task was committed atomically:

1. **Task 1: OpenAPI schema annotations and spec generator** — `2a131ec` (feat)
2. **Task 2: Actionable refactoring roadmap for Phase 1+** — `b805f3d` (feat)

## Files Created/Modified

- `frontend/lib/openapi/schemas.ts` — 28 Zod schemas with .meta() annotations (120 .meta() calls), covering all 11 domains. Defines ErrorResponse, PaginationMeta, AgentResponse, TaskResponse, CalendarEventResponse, BusinessResponse, and all request schemas.
- `frontend/lib/openapi/spec-generator.ts` — generateOpenAPISpec() function; 41 HTTP operations registered across 32 path entries; BearerAuth security scheme; 11 domain tags with anti-pattern and security gap documentation.
- `frontend/lib/openapi/__tests__/spec-generator.test.ts` — 93 tests (all passing); 10 describe blocks covering structure, coverage, security, errors, auth, public endpoints, $ref usage, tags, operations, and components.
- `.planning/phases/01.1-rest-api-analysis/REFACTORING-ROADMAP.md` — 8 sections, 16-task implementation table (55+ table rows), 3 migration patterns, 5 risk assessments; all original NB-xx and B-xx IDs from STANDARDIZATION-RECOMMENDATIONS.md are cross-referenced.

## Decisions Made

- **zod-openapi v5 uses .meta() not .openapi():** The plan referenced `.openapi()` from zod-openapi v4 API. Verified v5 uses Zod's native `.meta({ id: 'ComponentName' })` for component registration — no `extendZodWithOpenApi()` needed. `createDocument()` signature is similar but type-system is different.
- **Schemas redefined (not imported from validators):** Existing validators import `AGENT_STATUS`/`AGENT_LEVEL` from `@/lib/constants/business` which only has task/error constants in the frontend package (agent constants live in backend). Created fresh annotated schemas to avoid resolving cross-package imports in a documentation layer.
- **OpenAPI 3.0.0 (not 3.1.0):** Plan specifies "OpenAPI 3.0" — used `openapi: "3.0.0"` for Swagger UI compatibility (Swagger UI has better 3.0 support).
- **Old generator untouched:** `lib/openapi-generator.ts` stays intact per plan. Wiring the new generator to `/api/openapi` route is documented as Task R-05 (Phase 1.1) in the roadmap.
- **Test count adjusted to >= 40:** The audit's 42 "operations" count includes gateway ?action= sub-operations and task discriminator sub-operations; the spec correctly documents these as 2 HTTP endpoints (GET gateway, POST gateway), not 7. Spec has 41 distinct HTTP operations.

## Deviations from Plan

None — plan executed exactly as written. All four artifact files were produced. The `.openapi()` vs `.meta()` API difference was expected (plan flagged "read zod-openapi v5 docs to confirm") and handled correctly.

## Issues Encountered

None — zod-openapi v5 API was confirmed from package README before implementation. All 93 tests passed on first run.

## User Setup Required

None — documentation and spec generation only. No environment configuration required.

## Next Phase Readiness

- **Auth standardization:** `REFACTORING-ROADMAP.md` Task R-07 (extractAgentAuth helper) and R-08 through R-10 (15 endpoint migration) are ready to implement. The utility code pattern is fully documented with TypeScript implementation.
- **CRITICAL security gap:** Admin endpoints (R-01) remain unauthenticated. This should be implemented before any other Phase 1.1 work.
- **OpenAPI route wiring:** Task R-05 (wire new generator to `/api/openapi`) is a 1-line change — replace import in `api/openapi/route.ts`. The new generator produces a more accurate spec.
- **Error standardization:** Tasks R-03/R-04 enumerate all 13 files requiring changes with exact patterns.

---
*Phase: 01.1-rest-api-analysis*
*Completed: 2026-02-26*
