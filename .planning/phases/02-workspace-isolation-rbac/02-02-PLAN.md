---
phase: 02-workspace-isolation-rbac
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - backend/convex/schema.ts
  - backend/convex/workspaces.ts
  - backend/convex/rateLimit.ts
  - backend/convex/__tests__/workspaces.test.ts
  - backend/convex/__tests__/rateLimit.test.ts
autonomous: true
requirements:
  - WS-01
  - WS-03
  - WS-04

must_haves:
  truths:
    - "workspaces.create() requires callerId; throws NOT_FOUND if caller is not a system admin"
    - "workspaces.setDefault() requires callerId; throws NOT_FOUND if caller does not have admin role"
    - "workspaces table has createdBy field for audit trail"
    - "checkAndDecrement() in rateLimit.ts accepts optional roleTier parameter"
    - "Admin tier gets 5000/hr + 50000/day; agent/collaborator/viewer get 1000/hr + 10000/day (defaults)"
    - "Role-based quota initialized on first request (admin gets higher limits)"
  artifacts:
    - path: "backend/convex/schema.ts"
      provides: "workspaces.createdBy field; workspaces.budget field"
      contains: "createdBy"
    - path: "backend/convex/workspaces.ts"
      provides: "create() and setDefault() with admin-only guards via requireRole"
      contains: "requireRole"
    - path: "backend/convex/rateLimit.ts"
      provides: "checkAndDecrement() with roleTier parameter for admin vs standard limits"
      contains: "roleTier"
    - path: "backend/convex/__tests__/workspaces.test.ts"
      provides: "Tests for admin-only create, setDefault, createdBy audit"
      min_lines: 40
    - path: "backend/convex/__tests__/rateLimit.test.ts"
      provides: "Tests for role-based quota tiers"
      min_lines: 30
  key_links:
    - from: "workspaces.create()"
      to: "systemAdmins table check"
      via: "requireRole(ctx, workspaceId, callerId, 'admin') — but for workspace creation, check systemAdmins directly"
      pattern: "systemAdmins.*callerId"
    - from: "rateLimit.checkAndDecrement()"
      to: "apiKeyQuota initial record"
      via: "roleTier determines tokensPerHour/tokensPerDay on insert"
      pattern: "roleTier.*tokensPerHour"
---

<objective>
Extend Convex backend with admin-only workspace operations and role-based rate limits.

Purpose: Enforce that only system admins can create workspaces, only workspace admins can set default, and API rate limits tier by role. These are the operational guards that WS-01, WS-03, and WS-04 require.

Output: workspaces.ts with RBAC-guarded mutations; rateLimit.ts with role tiers; schema additions for createdBy + budget.
</objective>

<execution_context>
@/Users/arana/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-workspace-isolation-rbac/02-CONTEXT.md
@.planning/phases/02-workspace-isolation-rbac/02-RESEARCH.md
@.planning/phases/02-workspace-isolation-rbac/02-01-SUMMARY.md

<interfaces>
<!-- Types from Plan 01 that this plan builds upon -->

From backend/convex/organizationMembers.ts (created in Plan 01):
```typescript
export const ROLE_LEVELS = { admin: 4, agent: 3, collaborator: 2, viewer: 1 } as const;
export type UserRole = keyof typeof ROLE_LEVELS;
export function hasRequiredRole(userRole: UserRole, requiredRole: UserRole): boolean;
export async function requireRole(
  ctx: any,
  workspaceId: Id<"workspaces">,
  userId: string,
  requiredRole: UserRole
): Promise<void>; // throws ConvexError("NOT_FOUND") on failure
```

From backend/convex/rateLimit.ts (current signature to EXTEND):
```typescript
export const checkAndDecrement = mutation({
  args: { apiKeyId: convexVal.string() },
  handler: async (ctx, { apiKeyId }): Promise<RateLimitCheckResult>
});
// DEFAULT_TOKENS_PER_HOUR = 1000
// DEFAULT_TOKENS_PER_DAY = 10000
```

From backend/convex/workspaces.ts (create mutation to EXTEND):
```typescript
export const create = mutation({
  args: {
    name: convexVal.string(),
    slug: convexVal.string(),
    // ... existing args
    missionStatement: convexVal.string(),
  },
  // No callerId or admin check currently — this must be added
});

export const setDefault = ...; // Also needs admin guard
```

From backend/convex/schema.ts (workspaces table to EXTEND):
```typescript
workspaces: defineTable({
  name: convexVal.string(),
  slug: convexVal.string(),
  // Missing: createdBy, budget
  isDefault: convexVal.boolean(),
  createdAt: convexVal.number(),
  updatedAt: convexVal.number(),
})
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extensions — createdBy and budget fields</name>
  <files>
    backend/convex/schema.ts
  </files>
  <action>
Add two fields to the `workspaces` table in schema.ts:

1. `createdBy: convexVal.optional(convexVal.string())` — The userId of the system admin who created this workspace. Optional so existing workspaces without this field don't break. Place after `updatedAt`.

2. `budget: convexVal.optional(convexVal.object({ monthlyTokenLimit: convexVal.number(), alertThreshold: convexVal.optional(convexVal.number()) }))` — Per-workspace monthly budget. Optional, admin sets it. Place after `createdBy`.

These two fields together satisfy WS-01 (audit trail) and WS-03 (budget management).

No index changes needed for these fields.

Verify: TypeScript compiles with `npm run build 2>&1 | head -20`. No errors from schema.ts.
  </action>
  <verify>
    <automated>npm run build 2>&1 | grep -E "schema\.ts|error TS" | head -10</automated>
  </verify>
  <done>workspaces table in schema.ts has `createdBy` (optional string) and `budget` (optional object with monthlyTokenLimit + alertThreshold). Build passes without schema errors.</done>
</task>

<task type="auto">
  <name>Task 2: Admin-guarded workspace mutations + role-based rate limits</name>
  <files>
    backend/convex/workspaces.ts
    backend/convex/rateLimit.ts
    backend/convex/__tests__/workspaces.test.ts
    backend/convex/__tests__/rateLimit.test.ts
  </files>
  <action>
**Part A — workspaces.ts changes:**

1. Add `callerId` arg to `create()` mutation:
```typescript
args: {
  // ... existing args
  callerId: convexVal.string(), // system admin ID performing the creation
}
```

In the handler, BEFORE any workspace logic, check that caller is a system admin:
```typescript
const sysAdmin = await ctx.db
  .query("systemAdmins")
  .withIndex("by_user", (q: any) => q.eq("userId", callerId))
  .first();
if (!sysAdmin) {
  throw new ConvexError("NOT_FOUND"); // 404, not 403 (security through obscurity)
}
```

Store `createdBy` when inserting the workspace:
```typescript
await ctx.db.insert("workspaces", {
  // ... existing fields
  createdBy: callerId,
  createdAt: now,
  updatedAt: now,
});
```

2. Find `setDefault` mutation (or similar). Add `callerId` arg and add workspace admin check using `requireRole()` from Plan 01:
```typescript
// Import at top:
import { requireRole } from "./organizationMembers";

// In setDefault handler:
await requireRole(ctx, workspaceId, callerId, "admin");
```

3. Find any `setBudget` or budget-related mutation. If none exists, add:
```typescript
export const setBudget = mutation({
  args: {
    workspaceId: convexVal.id("workspaces"),
    callerId: convexVal.string(),
    monthlyTokenLimit: convexVal.number(),
    alertThreshold: convexVal.optional(convexVal.number()),
  },
  handler: async (ctx, args) => {
    await requireRole(ctx, args.workspaceId, args.callerId, "admin");
    const workspace = await ctx.db.get(args.workspaceId);
    if (!workspace) throw new ConvexError("NOT_FOUND");
    await ctx.db.patch(args.workspaceId, {
      budget: {
        monthlyTokenLimit: args.monthlyTokenLimit,
        alertThreshold: args.alertThreshold,
      },
      updatedAt: Date.now(),
    });
    return await ctx.db.get(args.workspaceId);
  },
});
```

**Part B — rateLimit.ts changes:**

Add `roleTier` optional parameter to `checkAndDecrement`:
```typescript
args: {
  apiKeyId: convexVal.string(),
  roleTier: convexVal.optional(
    convexVal.union(
      convexVal.literal("admin"),
      convexVal.literal("standard") // agent/collaborator/viewer all get standard
    )
  ),
}
```

Add role-based limits at top of file:
```typescript
const ADMIN_TOKENS_PER_HOUR = 5000;
const ADMIN_TOKENS_PER_DAY = 50000;
// DEFAULT_TOKENS_PER_HOUR = 1000 (unchanged)
// DEFAULT_TOKENS_PER_DAY = 10000 (unchanged)
```

In the handler, when creating a new quota record (the `if (!existing)` branch), use role-based limits:
```typescript
const tokensPerHour = roleTier === "admin" ? ADMIN_TOKENS_PER_HOUR : DEFAULT_TOKENS_PER_HOUR;
const tokensPerDay = roleTier === "admin" ? ADMIN_TOKENS_PER_DAY : DEFAULT_TOKENS_PER_DAY;

record = {
  apiKeyId,
  tokensRemaining: tokensPerHour - 1,
  tokensPerHour,
  tokensPerDay,
  // ...
};
```

**Part C — Tests:**

Write `backend/convex/__tests__/workspaces.test.ts`:
- Test: create() with valid system admin callerId succeeds
- Test: create() with non-system-admin callerId throws ConvexError("NOT_FOUND")
- Test: create() stores createdBy in the workspace record
- Test: setDefault() without admin role throws ConvexError("NOT_FOUND")
- Test: setBudget() sets budget on workspace when caller is admin

Write `backend/convex/__tests__/rateLimit.test.ts`:
- Test: admin tier gets 5000 tokens/hr on first request
- Test: standard tier gets 1000 tokens/hr on first request
- Test: no roleTier defaults to standard (1000/hr)

Run: `npm test -- --testPathPattern="workspaces|rateLimit"`
  </action>
  <verify>
    <automated>npm test -- --testPathPattern="workspaces|rateLimit" 2>&1 | grep -E "PASS|FAIL|Tests:"</automated>
  </verify>
  <done>All workspaces and rateLimit tests pass. workspaces.create() has system admin guard. workspaces.setDefault() has admin guard. workspaces.setBudget() exists and is admin-only. rateLimit.checkAndDecrement() accepts roleTier and sets appropriate limits on first request.</done>
</task>

</tasks>

<verification>
Run full targeted test suite:
```bash
npm test -- --testPathPattern="workspaces|rateLimit|organizationMembers"
```
Expected: All tests PASS (both new and Plan 01 tests still passing).

Build check:
```bash
npm run build 2>&1 | grep -c "error TS"
```
Expected: 0 errors.
</verification>

<success_criteria>
- [ ] workspaces table has `createdBy: optional(string)` and `budget: optional(object)` in schema.ts
- [ ] workspaces.create() throws ConvexError("NOT_FOUND") for non-system-admin callers
- [ ] workspaces.create() stores callerId in `createdBy`
- [ ] workspaces.setDefault() throws ConvexError("NOT_FOUND") for non-admin callers
- [ ] workspaces.setBudget() mutation exists and is admin-only
- [ ] rateLimit.checkAndDecrement() accepts optional `roleTier` parameter
- [ ] Admin tier initializes with 5000/hr + 50000/day; standard gets 1000/hr + 10000/day
- [ ] All tests pass: `npm test -- --testPathPattern="workspaces|rateLimit"`
</success_criteria>

<output>
After completion, create `.planning/phases/02-workspace-isolation-rbac/02-02-SUMMARY.md` with:
- Schema changes made (createdBy, budget fields)
- New mutations (setBudget)
- Modified mutations (create + callerId guard, setDefault + callerId guard, checkAndDecrement + roleTier)
- Any deviations from plan
</output>
