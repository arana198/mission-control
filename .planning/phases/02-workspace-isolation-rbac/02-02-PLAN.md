---
phase: 02-workspace-isolation-rbac
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/convex/schema.ts
  - backend/convex/workspaces.ts
  - backend/convex/__tests__/businesses.test.ts
  - backend/convex/__tests__/workspace-budget.test.ts
autonomous: true
requirements:
  - WS-01
  - WS-03
  - WS-04

must_haves:
  truths:
    - "Workspaces table has monthlyTokenBudget and currentMonthSpent fields"
    - "Admin can set workspace budget via mutation"
    - "Budget query returns current budget and spend for a workspace"
    - "setDefault mutation requires admin role (RBAC guard)"
    - "Workspace creation still works with all existing fields plus new budget fields"
  artifacts:
    - path: "backend/convex/schema.ts"
      provides: "Updated workspaces table with budget fields"
      contains: "monthlyTokenBudget"
    - path: "backend/convex/workspaces.ts"
      provides: "setBudget mutation, getBudget query, RBAC-guarded setDefault"
      exports: ["setBudget", "getBudget", "setDefault"]
    - path: "backend/convex/__tests__/workspace-budget.test.ts"
      provides: "Budget CRUD tests"
      min_lines: 50
  key_links:
    - from: "backend/convex/workspaces.ts"
      to: "backend/convex/schema.ts"
      via: "budget fields defined in schema, used in mutations"
      pattern: "monthlyTokenBudget"
---

<objective>
Extend the workspace schema with budget fields and add RBAC guards to workspace admin operations.

Purpose: WS-01 (workspace creation) is already implemented but needs budget field support. WS-03 (admin sets budget) requires new schema fields and mutations. WS-04 (admin sets default) needs RBAC guard enforcement. This plan adds the data layer without migrating existing functions (that happens in Plan 03).

Output: Updated schema with budget fields, new budget mutations/queries, RBAC-guarded setDefault.
</objective>

<execution_context>
@/Users/arana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-workspace-isolation-rbac/02-RESEARCH.md

<interfaces>
<!-- Key types from existing codebase -->

From backend/convex/schema.ts (workspaces table):
```typescript
workspaces: defineTable({
  name: convexVal.string(),
  slug: convexVal.string(),
  color: convexVal.optional(convexVal.string()),
  emoji: convexVal.optional(convexVal.string()),
  description: convexVal.optional(convexVal.string()),
  missionStatement: convexVal.optional(convexVal.string()),
  isDefault: convexVal.boolean(),
  createdAt: convexVal.number(),
  updatedAt: convexVal.number(),
})
  .index("by_slug", ["slug"])
  .index("by_default", ["isDefault"])
```

From backend/convex/workspaces.ts:
```typescript
export const setDefault = mutation({
  args: { workspaceId: convexVal.id("workspaces") },
  handler: wrapConvexHandler(async (ctx, { workspaceId }) => { ... }),
});

export const create = mutation({
  args: {
    name: convexVal.string(),
    slug: convexVal.string(),
    color: convexVal.optional(convexVal.string()),
    emoji: convexVal.optional(convexVal.string()),
    description: convexVal.optional(convexVal.string()),
    missionStatement: convexVal.string(),
  },
  handler: wrapConvexHandler(async (ctx, { ... }) => { ... }),
});
```

From backend/convex/organizationMembers.ts:
```typescript
export async function requireAdmin(
  ctx: any,
  workspaceId: Id<"workspaces">,
  userId: string
): Promise<void>
```

From backend/lib/errors/index.ts:
```typescript
import { ApiError, wrapConvexHandler } from "../lib/errors";
// ApiError.validationError(), ApiError.forbidden(), etc.
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend workspace schema with budget fields</name>
  <files>
    backend/convex/schema.ts
  </files>
  <action>
Add two optional number fields to the `workspaces` table definition in `backend/convex/schema.ts`:

```typescript
workspaces: defineTable({
  name: convexVal.string(),
  slug: convexVal.string(),
  color: convexVal.optional(convexVal.string()),
  emoji: convexVal.optional(convexVal.string()),
  description: convexVal.optional(convexVal.string()),
  missionStatement: convexVal.optional(convexVal.string()),
  isDefault: convexVal.boolean(),
  // Phase 2: Budget fields (WS-03)
  monthlyTokenBudget: convexVal.optional(convexVal.number()),  // Monthly token limit (null = unlimited)
  currentMonthSpent: convexVal.optional(convexVal.number()),    // Tokens consumed this month
  budgetResetAt: convexVal.optional(convexVal.number()),        // Timestamp when currentMonthSpent was last reset
  createdAt: convexVal.number(),
  updatedAt: convexVal.number(),
})
  .index("by_slug", ["slug"])
  .index("by_default", ["isDefault"])
```

Fields are optional (backward compatible -- no migration needed). Existing workspaces will have `undefined` for these fields, which means "no budget set" / "unlimited".

**IMPORTANT:** Do NOT change any other table definitions. Only add the 3 new fields to the `workspaces` table.
  </action>
  <verify>
    <automated>cd /Users/arana/dev/ankit/mission-control && npx -w backend tsc --noEmit</automated>
  </verify>
  <done>
    - workspaces table has monthlyTokenBudget, currentMonthSpent, budgetResetAt fields
    - All fields are optional (backward compatible)
    - TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Add budget mutations and RBAC-guard setDefault</name>
  <files>
    backend/convex/workspaces.ts
    backend/convex/__tests__/workspace-budget.test.ts
    backend/convex/__tests__/businesses.test.ts
  </files>
  <action>
**Step 1: Add budget mutations to workspaces.ts**

Add to `backend/convex/workspaces.ts`:

1. **`setBudget` mutation:** Sets monthly token budget for a workspace.
   - Args: `workspaceId: v.id("workspaces")`, `monthlyTokenBudget: v.number()` (must be >= 0)
   - Validates workspace exists (throw ApiError.notFound if not)
   - Validates budget >= 0 (throw ApiError.validationError if negative)
   - Patches workspace with `{ monthlyTokenBudget, updatedAt: Date.now() }`
   - Returns updated workspace
   - NOTE: This does NOT yet check admin role (RBAC guard will be added when functions.ts builders are integrated in Plan 03). For now, add a `// TODO: Phase 2 Plan 03 — migrate to adminMutation for RBAC` comment.

2. **`getBudget` query:** Returns budget info for a workspace.
   - Args: `workspaceId: v.id("workspaces")`
   - Returns `{ monthlyTokenBudget: number | null, currentMonthSpent: number, budgetResetAt: number | null, remainingBudget: number | null }`
   - If `monthlyTokenBudget` is undefined/null → `remainingBudget` is null (unlimited)
   - If defined → `remainingBudget = monthlyTokenBudget - (currentMonthSpent ?? 0)`

3. **RBAC guard on setDefault:** Update the existing `setDefault` mutation to call `requireAdmin(ctx, workspaceId, userId)` before proceeding. Add `userId: convexVal.string()` to args.
   - Import `requireAdmin` from `./organizationMembers`
   - Add `userId` arg
   - Call `await requireAdmin(ctx, workspaceId, userId)` as first line of handler
   - This is a bridge pattern until Plan 03 migrates to `adminMutation` builder

**Step 2: Write tests for budget operations**

Create `backend/convex/__tests__/workspace-budget.test.ts`:

Test the budget logic by mocking the Convex `ctx` object (same pattern as existing tests in `businesses.test.ts`):

1. `setBudget` with valid budget → patches workspace, returns updated
2. `setBudget` with negative budget → throws validation error
3. `setBudget` with non-existent workspace → throws not found
4. `getBudget` with budget set → returns budget info with remaining calculation
5. `getBudget` with no budget set → returns null for monthlyTokenBudget, null for remaining
6. `getBudget` with budget and spend → correct remaining calculation

**Step 3: Update existing setDefault tests**

In `backend/convex/__tests__/businesses.test.ts`, update any tests that call `setDefault` to include the new `userId` argument. If tests call the handler directly, add `userId: "test-user"` to args and mock `requireAdmin` to resolve (or mock the membership query).

**IMPORTANT:** Use `ApiError` from `../lib/errors` for all error throwing. Follow the existing pattern in `workspaces.ts` with `wrapConvexHandler`.

**NOTE ON ROLE SYSTEM:** This plan uses the EXISTING role system (`owner/admin/member`) via `requireAdmin()` from `organizationMembers.ts`. Plan 02-01 introduces a NEW 4-role hierarchy (`admin > agent > collaborator > viewer`) in `workspaceAuth.ts`. The two coexist: this plan's RBAC guard (`requireAdmin`) checks `owner`/`admin` from the existing schema, while Plan 02-03 will migrate mutations to `adminMutation` builder which maps `owner` → admin level using the new hierarchy. A full role data migration (updating membership records) is deferred to a future phase.
  </action>
  <verify>
    <automated>cd /Users/arana/dev/ankit/mission-control && npm test -- --testPathPattern="workspace-budget|businesses|workspaces"</automated>
  </verify>
  <postcondition>
**Regression check (WS-01):** After adding the 3 optional budget fields to schema, verify the existing `workspaces.create` mutation still works. Run:
```bash
cd /Users/arana/dev/ankit/mission-control && npm test -- --testPathPattern="businesses" --verbose 2>&1 | grep -E "(create|PASS|FAIL)"
```
If no existing test covers `workspaces.create`, add a minimal regression test in `workspace-budget.test.ts`:
```typescript
describe("workspace creation regression (WS-01)", () => {
  it("create mutation still works after schema extension", async () => {
    // Verify create handler accepts original args without budget fields
    // Budget fields are optional — existing create calls must not break
  });
});
```
  </postcondition>
  <done>
    - setBudget mutation validates and persists budget
    - getBudget query returns correct budget info with remaining calculation
    - setDefault now requires userId + calls requireAdmin
    - All existing businesses tests still pass (no regressions)
    - Workspace creation (WS-01) still works after schema changes (regression verified)
    - New budget tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Budget, workspace, and businesses tests pass (includes WS-01 create regression)
cd /Users/arana/dev/ankit/mission-control && npm test -- --testPathPattern="workspace-budget|businesses|workspaces"

# TypeScript compiles
cd /Users/arana/dev/ankit/mission-control && npm run build

# Schema fields exist
grep "monthlyTokenBudget" backend/convex/schema.ts
grep "setBudget" backend/convex/workspaces.ts

# Verify workspace create mutation still exported (WS-01 regression)
grep "export const create" backend/convex/workspaces.ts
```
</verification>

<success_criteria>
- Schema extended with 3 budget fields (backward compatible, optional)
- setBudget mutation validates and persists monthly budget
- getBudget query computes remaining budget correctly
- setDefault now requires admin role check
- All existing tests pass (no regressions)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-workspace-isolation-rbac/02-02-SUMMARY.md`
</output>
