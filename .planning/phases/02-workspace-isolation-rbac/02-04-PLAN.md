---
phase: 02-workspace-isolation-rbac
plan: 04
type: execute
wave: 3
depends_on:
  - 02-02
  - 02-03
files_modified:
  - frontend/src/components/WorkspaceProvider.tsx
  - frontend/src/app/api/v1/workspaces/[workspaceId]/route.ts
  - frontend/src/app/api/v1/workspaces/[workspaceId]/tasks/route.ts
  - frontend/src/app/api/v1/workspaces/[workspaceId]/agents/route.ts
  - frontend/lib/api/workspaceContext.ts
  - frontend/src/app/api/__tests__/workspace-api.test.ts
autonomous: false
requirements:
  - WS-05
  - WS-06

must_haves:
  truths:
    - "WorkspaceProvider queries getMyWorkspaces instead of getAll (membership-filtered)"
    - "Users see only workspaces they have membership in"
    - "API routes at /api/v1/workspaces/{workspaceId}/... extract workspaceId from URL path"
    - "API routes validate workspaceId exists before processing request"
    - "Invalid workspaceId in URL returns 404"
    - "Workspace context is propagated to Convex calls from API routes"
  artifacts:
    - path: "frontend/src/components/WorkspaceProvider.tsx"
      provides: "Membership-filtered workspace list"
      contains: "getMyWorkspaces"
    - path: "frontend/lib/api/workspaceContext.ts"
      provides: "URL-based workspace extraction utility for API routes"
      exports: ["extractWorkspaceId", "validateWorkspaceAccess"]
    - path: "frontend/src/app/api/v1/workspaces/[workspaceId]/tasks/route.ts"
      provides: "Example workspace-scoped API route with URL path context"
      exports: ["GET"]
    - path: "frontend/src/app/api/__tests__/workspace-api.test.ts"
      provides: "Integration tests for workspace context propagation"
      min_lines: 80
  key_links:
    - from: "frontend/src/components/WorkspaceProvider.tsx"
      to: "backend/convex/workspaces.ts"
      via: "useQuery(api.workspaces.getMyWorkspaces)"
      pattern: "getMyWorkspaces"
    - from: "frontend/src/app/api/v1/workspaces/[workspaceId]/tasks/route.ts"
      to: "frontend/lib/api/workspaceContext.ts"
      via: "extractWorkspaceId from URL params"
      pattern: "extractWorkspaceId"
    - from: "frontend/lib/api/workspaceContext.ts"
      to: "backend/convex/workspaces.ts"
      via: "validates workspace exists via Convex query"
      pattern: "api.workspaces.getWorkspaceById"
---

<objective>
Wire the frontend to use membership-filtered workspace list and create workspace-scoped API routes at `/api/v1/workspaces/{workspaceId}/...` that extract workspace context from the URL path.

Purpose: WS-05 (users see only assigned workspaces) requires the frontend WorkspaceProvider to filter by membership. WS-06 (workspace context in API URL path) requires restructuring API routes to use URL-based workspace identification. This completes the end-to-end workspace isolation from database through API to frontend.

Output: Updated WorkspaceProvider, workspace context extraction utility, example workspace-scoped API routes, integration tests.
</objective>

<execution_context>
@/Users/arana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-workspace-isolation-rbac/02-RESEARCH.md
@.planning/phases/02-workspace-isolation-rbac/02-02-SUMMARY.md
@.planning/phases/02-workspace-isolation-rbac/02-03-SUMMARY.md

<interfaces>
<!-- From Plan 03 outputs -->

From backend/convex/workspaces.ts (Plan 03):
```typescript
export const getMyWorkspaces = query({
  args: { userId: convexVal.string() },
  handler: async (ctx, { userId }) => {
    // Returns workspaces filtered by membership, sorted by name
    // Each workspace includes role from membership
  },
});

// Still available (deprecated):
export const getAll = query({ ... });
export const getWorkspaceById = query({ args: { workspaceId }, ... });
```

From frontend/src/components/WorkspaceProvider.tsx (current):
```typescript
// Currently queries ALL workspaces (no membership filter)
const workspaces = useQuery(api.workspaces.getAll);

export function WorkspaceProvider({ children }: { children: React.ReactNode })
export function useWorkspace(): WorkspaceContextType
```

From frontend/lib/api/auth.ts (existing):
```typescript
export async function verifyAgent(agentId: string, apiKey: string): Promise<VerifiedAgent | null>
```

From Convex client usage in API routes:
```typescript
import { ConvexHttpClient } from "convex/browser";
import { api } from "@/convex/_generated/api";
const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update WorkspaceProvider to use membership-filtered query</name>
  <files>
    frontend/src/components/WorkspaceProvider.tsx
  </files>
  <action>
Update `frontend/src/components/WorkspaceProvider.tsx`:

1. **Change workspace query from `getAll` to `getMyWorkspaces`:**

Replace:
```typescript
const workspaces = useQuery(api.workspaces.getAll);
```

With:
```typescript
// TODO: Replace hardcoded userId with actual auth identity when Convex Auth is integrated
// For now, use a stable user identifier from localStorage or a default
const userId = typeof window !== 'undefined'
  ? localStorage.getItem("mission-control:userId") || "default-user"
  : "default-user";

const workspaces = useQuery(api.workspaces.getMyWorkspaces, { userId });
```

**NOTE ON AUTH:** The current app does not have Convex Auth integrated (per research -- deferred to a future phase). The `userId` value is a placeholder. When Convex Auth is added, this will use `ctx.auth.getUserIdentity()`. For now, use localStorage-based user ID. This is documented as a known limitation.

2. **Update the Workspace interface** to include the optional `role` field:
```typescript
export interface Workspace {
  _id: string;
  name: string;
  slug: string;
  color?: string;
  emoji?: string;
  description?: string;
  missionStatement?: string;
  isDefault: boolean;
  createdAt: number;
  updatedAt: number;
  role?: string;  // Phase 2: user's role in this workspace
}
```

3. **Keep all other logic the same** -- the fallback chain (URL → localStorage → default → first) still works. The difference is the workspace list is now filtered by membership.

4. **Add a `hasNoAccess` state** for the case where the user has no workspace memberships:
```typescript
const hasNoAccess = !isLoading && workspacesData.length === 0;
```
Export this in the context so the UI can show an appropriate message.

**IMPORTANT:** Do NOT break the existing workspace switching flow. The `setCurrentWorkspace` function and localStorage persistence should work exactly the same.
  </action>
  <verify>
    <automated>cd /Users/arana/dev/ankit/mission-control && npm run build</automated>
  </verify>
  <done>
    - WorkspaceProvider queries getMyWorkspaces instead of getAll
    - Users see only workspaces they belong to
    - Workspace interface includes optional role field
    - hasNoAccess state available in context
    - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workspace context extraction and example API routes</name>
  <files>
    frontend/lib/api/workspaceContext.ts
    frontend/src/app/api/v1/workspaces/[workspaceId]/route.ts
    frontend/src/app/api/v1/workspaces/[workspaceId]/tasks/route.ts
    frontend/src/app/api/v1/workspaces/[workspaceId]/agents/route.ts
    frontend/src/app/api/__tests__/workspace-api.test.ts
  </files>
  <action>
**Step 1: Create workspace context extraction utility**

Create `frontend/lib/api/workspaceContext.ts`:

```typescript
/**
 * Workspace Context Extraction for API Routes
 *
 * Extracts and validates workspaceId from URL path parameters.
 * Used by all /api/v1/workspaces/{workspaceId}/... routes.
 */
import { ConvexHttpClient } from "convex/browser";
import { api } from "@/convex/_generated/api";

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export interface WorkspaceContext {
  workspaceId: string;
  workspace: { _id: string; name: string; slug: string };
}

/**
 * Extract workspaceId from Next.js route params
 * Returns the workspaceId string or null if not present
 */
export function extractWorkspaceId(
  params: { workspaceId?: string } | Promise<{ workspaceId?: string }>
): string | null {
  // Handle both sync and async params (Next.js 15 compatibility)
  if (params instanceof Promise) {
    throw new Error("Use extractWorkspaceIdAsync for async params");
  }
  return params.workspaceId ?? null;
}

/**
 * Async version for Next.js 15 route handlers where params is a Promise
 */
export async function extractWorkspaceIdAsync(
  params: Promise<{ workspaceId?: string }>
): Promise<string | null> {
  const resolved = await params;
  return resolved.workspaceId ?? null;
}

/**
 * Validate that a workspaceId corresponds to an existing workspace.
 * Returns the workspace object or null if not found.
 */
export async function validateWorkspaceAccess(
  workspaceId: string
): Promise<WorkspaceContext | null> {
  try {
    const workspace = await convex.query(api.workspaces.getWorkspaceById, {
      workspaceId: workspaceId as any,
    });
    if (!workspace) return null;
    return {
      workspaceId: workspace._id,
      workspace: { _id: workspace._id, name: workspace.name, slug: workspace.slug },
    };
  } catch {
    return null;
  }
}

/**
 * Standard error response for invalid workspace
 */
export function workspaceNotFoundResponse(workspaceId: string): Response {
  return Response.json(
    {
      success: false,
      error: {
        code: "WORKSPACE_NOT_FOUND",
        message: `Workspace '${workspaceId}' not found`,
        status: 404,
      },
    },
    { status: 404 }
  );
}
```

**Step 2: Create workspace-scoped API route structure**

Create `frontend/src/app/api/v1/workspaces/[workspaceId]/route.ts`:

```typescript
/**
 * GET /api/v1/workspaces/{workspaceId} — Get workspace details
 */
import { extractWorkspaceIdAsync, validateWorkspaceAccess, workspaceNotFoundResponse } from "@/lib/api/workspaceContext";

export async function GET(
  request: Request,
  { params }: { params: Promise<{ workspaceId: string }> }
) {
  const workspaceId = await extractWorkspaceIdAsync(params);
  if (!workspaceId) {
    return workspaceNotFoundResponse("unknown");
  }

  const wsCtx = await validateWorkspaceAccess(workspaceId);
  if (!wsCtx) {
    return workspaceNotFoundResponse(workspaceId);
  }

  return Response.json({ success: true, data: wsCtx.workspace });
}
```

Create `frontend/src/app/api/v1/workspaces/[workspaceId]/tasks/route.ts`:

```typescript
/**
 * GET /api/v1/workspaces/{workspaceId}/tasks — List tasks in workspace
 * POST /api/v1/workspaces/{workspaceId}/tasks — Create task in workspace
 */
import { ConvexHttpClient } from "convex/browser";
import { api } from "@/convex/_generated/api";
import { extractWorkspaceIdAsync, validateWorkspaceAccess, workspaceNotFoundResponse } from "@/lib/api/workspaceContext";

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export async function GET(
  request: Request,
  { params }: { params: Promise<{ workspaceId: string }> }
) {
  const workspaceId = await extractWorkspaceIdAsync(params);
  if (!workspaceId) {
    return workspaceNotFoundResponse("unknown");
  }

  const wsCtx = await validateWorkspaceAccess(workspaceId);
  if (!wsCtx) {
    return workspaceNotFoundResponse(workspaceId);
  }

  // Pass validated workspaceId to Convex (workspace-scoped query)
  try {
    const tasks = await convex.query(api.tasks.getAll, {
      workspaceId: wsCtx.workspaceId as any,
    });
    return Response.json({ success: true, data: tasks });
  } catch (error) {
    return Response.json(
      { success: false, error: { code: "INTERNAL_ERROR", message: String(error) } },
      { status: 500 }
    );
  }
}
```

Create `frontend/src/app/api/v1/workspaces/[workspaceId]/agents/route.ts`:

```typescript
/**
 * GET /api/v1/workspaces/{workspaceId}/agents — List agents accessible in workspace
 */
import { ConvexHttpClient } from "convex/browser";
import { api } from "@/convex/_generated/api";
import { extractWorkspaceIdAsync, validateWorkspaceAccess, workspaceNotFoundResponse } from "@/lib/api/workspaceContext";

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export async function GET(
  request: Request,
  { params }: { params: Promise<{ workspaceId: string }> }
) {
  const workspaceId = await extractWorkspaceIdAsync(params);
  if (!workspaceId) {
    return workspaceNotFoundResponse("unknown");
  }

  const wsCtx = await validateWorkspaceAccess(workspaceId);
  if (!wsCtx) {
    return workspaceNotFoundResponse(workspaceId);
  }

  // Agents are global but we can filter by workspace assignment later
  // For now, return all agents (agents are shared across workspaces per architecture decision)
  try {
    const agents = await convex.query(api.agents.getAllAgents);
    return Response.json({ success: true, data: agents });
  } catch (error) {
    return Response.json(
      { success: false, error: { code: "INTERNAL_ERROR", message: String(error) } },
      { status: 500 }
    );
  }
}
```

**Step 3: Write integration tests**

Create `frontend/src/app/api/__tests__/workspace-api.test.ts`:

Mock `ConvexHttpClient` and test:

1. **GET /api/v1/workspaces/{workspaceId}** — valid ID returns workspace data
2. **GET /api/v1/workspaces/{workspaceId}** — invalid ID returns 404 with WORKSPACE_NOT_FOUND
3. **GET /api/v1/workspaces/{workspaceId}/tasks** — valid workspace returns tasks array
4. **GET /api/v1/workspaces/{workspaceId}/tasks** — invalid workspace returns 404
5. **extractWorkspaceId** — extracts from params correctly
6. **extractWorkspaceId** — returns null when workspaceId missing
7. **validateWorkspaceAccess** — returns null for non-existent workspace
8. **workspaceNotFoundResponse** — returns correct 404 shape

**IMPORTANT:** Follow the existing API route test patterns from `frontend/src/app/api/agents/__tests__/register.test.ts` -- mock `convex/browser` and `@/convex/_generated/api`, test the route handler directly.
  </action>
  <verify>
    <automated>cd /Users/arana/dev/ankit/mission-control && npm test -- --testPathPattern="workspace-api"</automated>
  </verify>
  <done>
    - workspaceContext.ts provides extractWorkspaceId, validateWorkspaceAccess, workspaceNotFoundResponse
    - /api/v1/workspaces/[workspaceId]/route.ts returns workspace by ID
    - /api/v1/workspaces/[workspaceId]/tasks/route.ts returns workspace-scoped tasks
    - /api/v1/workspaces/[workspaceId]/agents/route.ts returns agents for workspace
    - All integration tests pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Manual verification of workspace isolation end-to-end</name>
  <files>
    frontend/src/components/WorkspaceProvider.tsx
    frontend/src/app/api/v1/workspaces/[workspaceId]/route.ts
  </files>
  <action>
Human verifies end-to-end workspace isolation. What was built:
1. RBAC role hierarchy (admin > agent > collaborator > viewer)
2. Workspace-scoped Convex function builders (workspaceQuery/workspaceMutation/adminMutation)
3. Schema extended with budget fields
4. All workspace-scoped Convex functions migrated to builders
5. WorkspaceProvider filtered by membership
6. API routes at /api/v1/workspaces/{workspaceId}/...

Verification steps:
1. Start Convex backend: `npm run convex:dev` (Terminal 1)
2. Start Next.js frontend: `npm run dev` (Terminal 2)
3. Open browser to http://localhost:3000
4. Verify: Application loads without errors
5. Verify: Workspace selector shows only workspaces you belong to (not all)
6. Verify: Switching workspaces filters data correctly (tasks, activities change)
7. Test API: `curl http://localhost:3000/api/v1/workspaces/{valid-id}` returns 200 with workspace data
8. Test API: `curl http://localhost:3000/api/v1/workspaces/invalid-id` returns 404 with error
9. Check browser console: no errors
10. Run full validation: `npm run validate`

Resume signal: Type "approved" or describe issues to fix
  </action>
  <verify>
    <automated>cd /Users/arana/dev/ankit/mission-control && npm run validate</automated>
  </verify>
  <done>
    - Application loads without errors
    - Workspace selector shows only membership-filtered workspaces
    - Workspace switching filters data correctly
    - API routes return correct workspace data
    - Invalid workspace IDs return 404
    - npm run validate passes
  </done>
</task>

</tasks>

<verification>
```bash
# All tests pass
cd /Users/arana/dev/ankit/mission-control && npm run validate

# Workspace API tests
npm test -- --testPathPattern=workspace-api

# Build passes
npm run build

# API routes exist
ls frontend/src/app/api/v1/workspaces/\[workspaceId\]/
ls frontend/src/app/api/v1/workspaces/\[workspaceId\]/tasks/
ls frontend/src/app/api/v1/workspaces/\[workspaceId\]/agents/
```
</verification>

<success_criteria>
- WorkspaceProvider uses getMyWorkspaces (membership-filtered)
- /api/v1/workspaces/{workspaceId}/* routes extract workspace from URL
- Invalid workspace IDs return 404
- workspace context propagated to all Convex calls
- All tests pass including new integration tests
- Manual verification: app loads, workspace switching works, data is scoped
</success_criteria>

<output>
After completion, create `.planning/phases/02-workspace-isolation-rbac/02-04-SUMMARY.md`
</output>
