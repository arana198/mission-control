---
phase: 02-workspace-isolation-rbac
plan: 04
type: execute
wave: 3
depends_on:
  - 02-01
  - 02-02
files_modified:
  - frontend/lib/api/rbac.ts
  - frontend/middleware.ts
  - frontend/src/app/api/v1/workspaces/[workspaceId]/agents/route.ts
  - frontend/src/app/api/admin/workspaces/route.ts
  - frontend/lib/api/__tests__/rbac.test.ts
autonomous: true
requirements:
  - WS-05
  - WS-06
  - WS-01
  - WS-04

must_haves:
  truths:
    - "Every workspace-scoped API route enforces workspace membership before returning data"
    - "requireWorkspaceRole() in frontend/lib/api/rbac.ts validates membership via Convex query on every request (no caching)"
    - "Invalid or inaccessible workspace returns 404 (not 403) from API routes"
    - "The agents route TODO comment is replaced with a real requireWorkspaceRole() call"
    - "/api/admin/workspaces route exists for system-admin workspace creation (bypasses workspace middleware)"
    - "Workspace context (workspaceId + caller role) propagated via response headers to downstream handlers"
    - "Existing passing tests continue to pass after middleware changes"
  artifacts:
    - path: "frontend/lib/api/rbac.ts"
      provides: "requireWorkspaceRole() — validates workspace membership via Convex, returns 404 on failure"
      exports: ["requireWorkspaceRole", "WorkspaceRoleContext"]
    - path: "frontend/lib/api/__tests__/rbac.test.ts"
      provides: "Unit tests for requireWorkspaceRole"
      min_lines: 50
    - path: "frontend/src/app/api/admin/workspaces/route.ts"
      provides: "POST /api/admin/workspaces — system admin workspace creation"
      exports: ["POST"]
    - path: "frontend/src/app/api/v1/workspaces/[workspaceId]/agents/route.ts"
      provides: "TODO replaced with requireWorkspaceRole() call"
      contains: "requireWorkspaceRole"
    - path: "frontend/middleware.ts"
      provides: "Workspace membership validated in middleware; caller role attached to x-caller-role header"
      contains: "x-caller-role"
  key_links:
    - from: "frontend/middleware.ts"
      to: "frontend/lib/api/rbac.ts requireWorkspaceRole()"
      via: "Middleware calls requireWorkspaceRole for all /api/v1/workspaces/* routes"
      pattern: "requireWorkspaceRole"
    - from: "requireWorkspaceRole()"
      to: "Convex organizationMembers.hasAccess query"
      via: "ConvexHttpClient query on every request"
      pattern: "organizationMembers.*hasAccess"
    - from: "/api/admin/workspaces POST"
      to: "Convex workspaces.create() mutation"
      via: "callerId extracted from API key, passed as arg"
      pattern: "workspaces.*create.*callerId"
---

<objective>
Create the frontend RBAC enforcement layer: rbac.ts helper, admin endpoint, and middleware workspace membership validation.

Purpose: The Convex layer (Plans 01-03) defends at the data level. This plan adds the API middleware layer — the first line of defense that stops unauthorized requests before they reach Convex. Defense-in-depth requires both layers.

Output: requireWorkspaceRole() helper used in all workspace-scoped routes; /api/admin/workspaces for system admin ops; middleware attaches caller role to headers.
</objective>

<execution_context>
@/Users/arana/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-workspace-isolation-rbac/02-CONTEXT.md
@.planning/phases/02-workspace-isolation-rbac/02-RESEARCH.md
@.planning/phases/02-workspace-isolation-rbac/02-01-SUMMARY.md
@.planning/phases/02-workspace-isolation-rbac/02-02-SUMMARY.md

<interfaces>
<!-- Key types the executor must use, extracted from codebase -->

From frontend/lib/api/routeHelpers.ts (existing, do NOT recreate):
```typescript
export function extractWorkspaceIdFromPath(pathname: string): string | null
export function createErrorResponseObject(status: number, ...): ErrorResponseObject
export function validateWorkspaceAccess(...): ...
```

From frontend/middleware.ts (current pattern to EXTEND):
```typescript
// Already extracts workspace ID and sets headers:
response.headers.set("x-workspace-id", context.workspaceId);
response.headers.set("x-api-key-id", context.apiKeyId);

// Middleware reads request.headers.get("x-workspace-id")
// and request.headers.get("x-api-key-id") in route handlers
```

From frontend/lib/api/errors.ts (existing error classes):
```typescript
export class NotFoundError extends ApiError { ... }  // 404
export class UnauthorizedError extends ApiError { ... }  // 401
export class ForbiddenError extends ApiError { ... }  // 403 — do NOT use for workspace checks
```

From backend Convex API (Plan 01 output — for Convex HTTP client calls):
```typescript
// organizationMembers.hasAccess query:
args: {
  workspaceId: Id<"workspaces">,
  userId: string,
  requiredRole: optional("admin" | "agent" | "collaborator" | "viewer" | "owner" | "member")
}
returns: boolean
```

From agents route (existing TODO to fix):
```typescript
// frontend/src/app/api/v1/workspaces/[workspaceId]/agents/route.ts line 113:
// TODO: Validate workspace access when workspace context is available
```

Locked decisions:
- Return 404 (not 403) when workspace is invalid or user lacks access
- Validate membership on EVERY request — no caching
- Admin endpoints at /api/admin/... do NOT go through workspace middleware
- x-api-key-id header set by middleware contains the agent's raw API key (used as userId for membership lookup)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create frontend/lib/api/rbac.ts + tests</name>
  <files>
    frontend/lib/api/rbac.ts
    frontend/lib/api/__tests__/rbac.test.ts
  </files>
  <action>
**Create `frontend/lib/api/rbac.ts`:**

This module provides the `requireWorkspaceRole()` function used by route handlers (and middleware) to validate workspace membership.

```typescript
/**
 * Frontend RBAC Helpers
 * Validates workspace membership via Convex on every request (no caching).
 *
 * Key design decisions (from CONTEXT.md):
 * - Returns 404 (not 403) when access denied (security through obscurity)
 * - Validates on every request — no caching
 * - No cross-workspace queries
 */

import { ConvexHttpClient } from "convex/browser";
import { api } from "@/convex/_generated/api";
import { NotFoundError } from "./errors";
import { generateRequestId } from "./responses";

export type WorkspaceUserRole = "admin" | "agent" | "collaborator" | "viewer";

export interface WorkspaceRoleContext {
  workspaceId: string;
  userId: string;       // The agent ID (from x-api-key-id header)
  userRole: WorkspaceUserRole;
}

/**
 * Validate that userId is a member of workspaceId with at least requiredRole.
 * Throws NotFoundError (404) on any failure — never 403.
 *
 * @param workspaceId - Convex workspace ID from URL path
 * @param userId - Agent ID from x-api-key-id header
 * @param requiredRole - Minimum required role (default: "viewer")
 * @returns WorkspaceRoleContext with validated membership
 * @throws NotFoundError (404) if workspace doesn't exist or user lacks access
 */
export async function requireWorkspaceRole(
  workspaceId: string,
  userId: string,
  requiredRole: WorkspaceUserRole = "viewer"
): Promise<WorkspaceRoleContext> {
  const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

  let hasAccess: boolean;
  try {
    hasAccess = await convex.query(api.organizationMembers.hasAccess, {
      workspaceId: workspaceId as any,
      userId,
      requiredRole,
    });
  } catch (err) {
    // Convex error (invalid ID format, etc.) → treat as 404
    throw new NotFoundError(generateRequestId());
  }

  if (!hasAccess) {
    // 404, not 403 (security through obscurity — per locked decision)
    throw new NotFoundError(generateRequestId());
  }

  return {
    workspaceId,
    userId,
    userRole: requiredRole, // Minimum met — actual role returned separately if needed
  };
}
```

NOTES:
- Use `ConvexHttpClient` from `"convex/browser"` (works in Next.js API routes and Edge middleware)
- `process.env.NEXT_PUBLIC_CONVEX_URL` is already configured in this project
- Check that `api.organizationMembers.hasAccess` is the correct API path by looking at how other route handlers import the Convex API
- If the import path for `api` is different in this project, adapt accordingly (look at existing route.ts files for the correct import)

**Create `frontend/lib/api/__tests__/rbac.test.ts`:**

```typescript
describe('requireWorkspaceRole', () => {
  it('returns WorkspaceRoleContext when membership confirmed')
  it('throws NotFoundError (404) when hasAccess returns false')
  it('throws NotFoundError (404) when Convex throws (invalid workspaceId)')
  it('defaults to viewer role when requiredRole not specified')
  it('calls hasAccess with correct workspaceId, userId, requiredRole')
})
```

Mock `convex/browser` ConvexHttpClient in tests. Run: `npm test -- --testPathPattern="rbac"`
  </action>
  <verify>
    <automated>npm test -- --testPathPattern="rbac" 2>&1 | grep -E "PASS|FAIL|Tests:"</automated>
  </verify>
  <done>frontend/lib/api/rbac.ts exists with requireWorkspaceRole() exported. All rbac tests pass. NotFoundError thrown for any access failure (never ForbiddenError).</done>
</task>

<task type="auto">
  <name>Task 2: Wire requireWorkspaceRole into agents route + create /api/admin/workspaces</name>
  <files>
    frontend/src/app/api/v1/workspaces/[workspaceId]/agents/route.ts
    frontend/src/app/api/admin/workspaces/route.ts
    frontend/middleware.ts
  </files>
  <action>
**Part A — Fix agents route TODO:**

Open `frontend/src/app/api/v1/workspaces/[workspaceId]/agents/route.ts`.

Find the TODO comment at line 113 (approx):
```typescript
// TODO: Validate workspace access when workspace context is available
```

Replace it with actual validation using the new rbac.ts module:
```typescript
// Get workspace ID and caller ID from middleware-injected headers
const workspaceId = request.headers.get("x-workspace-id");
const callerId = request.headers.get("x-api-key-id");

if (!workspaceId || !callerId) {
  return NextResponse.json(
    createErrorResponseObject(404, "Not Found", "", request.url),
    { status: 404 }
  );
}

// Validate workspace membership (viewer+ for reads, collaborator+ for writes)
// For list/GET: viewer. For POST: collaborator.
await requireWorkspaceRole(workspaceId, callerId, "viewer"); // throws NotFoundError on failure
```

Import at top of file:
```typescript
import { requireWorkspaceRole } from "@/lib/api/rbac";
```

Wrap the requireWorkspaceRole call in try/catch — convert NotFoundError to 404 response:
```typescript
try {
  await requireWorkspaceRole(workspaceId, callerId, "viewer");
} catch (err) {
  return NextResponse.json(
    createErrorResponseObject(404, "Not Found", "", request.url),
    { status: 404 }
  );
}
```

Look at how the route currently handles requests and fit this validation at the start of the GET and POST handlers.

**Part B — Create /api/admin/workspaces route:**

Create directory: `frontend/src/app/api/admin/workspaces/`
Create file: `frontend/src/app/api/admin/workspaces/route.ts`

This route handles workspace CRUD for system admins. It does NOT go through the workspace-scoped middleware (no [workspaceId] in path).

```typescript
import { NextRequest, NextResponse } from "next/server";
import { ConvexHttpClient } from "convex/browser";
import { api } from "@/convex/_generated/api";
import { createErrorResponseObject } from "@/lib/api/routeHelpers";

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

/**
 * POST /api/admin/workspaces
 * Create a new workspace (system admin only).
 * System admin check happens in Convex (workspaces.create checks systemAdmins table).
 */
export async function POST(request: NextRequest) {
  const callerId = request.headers.get("x-api-key-id");
  if (!callerId) {
    return NextResponse.json(
      createErrorResponseObject(401, "Unauthorized", "API key required", request.url),
      { status: 401 }
    );
  }

  let body: any;
  try {
    body = await request.json();
  } catch {
    return NextResponse.json(
      createErrorResponseObject(400, "Bad Request", "Invalid JSON body", request.url),
      { status: 400 }
    );
  }

  const { name, slug, missionStatement, color, emoji, description } = body;
  if (!name || !slug || !missionStatement) {
    return NextResponse.json(
      createErrorResponseObject(400, "Bad Request", "name, slug, and missionStatement are required", request.url),
      { status: 400 }
    );
  }

  try {
    const workspace = await convex.mutation(api.workspaces.create, {
      name, slug, missionStatement, color, emoji, description,
      callerId,
    });
    return NextResponse.json({ data: workspace, success: true }, { status: 201 });
  } catch (err: any) {
    if (err.message?.includes("NOT_FOUND")) {
      return NextResponse.json(
        createErrorResponseObject(404, "Not Found", "", request.url),
        { status: 404 }
      );
    }
    return NextResponse.json(
      createErrorResponseObject(500, "Internal Server Error", "Failed to create workspace", request.url),
      { status: 500 }
    );
  }
}
```

**Part C — middleware.ts: attach x-caller-role header:**

In `frontend/middleware.ts`, after the workspace membership check, attach the caller's role to response headers so downstream route handlers don't need to re-query it:

Find where `x-workspace-id` and `x-api-key-id` are set. After those lines, add:
```typescript
// Note: Role lookup is optional here — route handlers call requireWorkspaceRole themselves.
// We set a placeholder; the actual role is verified per-request in rbac.ts.
response.headers.set("x-caller-role", "pending"); // Route handlers verify via requireWorkspaceRole
```

Also ensure the middleware passes through `/api/admin/*` routes WITHOUT workspace validation (they bypass the workspace middleware):
```typescript
// Admin routes bypass workspace middleware
if (pathname.startsWith("/api/admin/")) {
  return NextResponse.next();
}
```

Add this check BEFORE the workspace ID extraction logic in middleware.

Run tests to ensure no regression: `npm test -- --testPathPattern="middleware|agents|rbac"`
  </action>
  <verify>
    <automated>npm test -- --testPathPattern="middleware|agents|rbac" 2>&1 | grep -E "PASS|FAIL|Tests:"</automated>
  </verify>
  <done>agents/route.ts has requireWorkspaceRole() replacing the TODO. /api/admin/workspaces/route.ts exists with POST handler. middleware.ts bypasses /api/admin/* routes. All existing tests still pass (no regression).</done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
npm test 2>&1 | tail -20
```
Expected: No new test failures (all previously passing tests still pass).

Verify agents route has RBAC:
```bash
grep -n "requireWorkspaceRole" /Users/arana/dev/ankit/mission-control/frontend/src/app/api/v1/workspaces/\[workspaceId\]/agents/route.ts
```
Expected: At least 1 match.

Verify admin route exists:
```bash
ls /Users/arana/dev/ankit/mission-control/frontend/src/app/api/admin/workspaces/route.ts
```
Expected: File exists.

Build check:
```bash
npm run build 2>&1 | grep -c "error TS"
```
Expected: 0 errors.
</verification>

<success_criteria>
- [ ] `frontend/lib/api/rbac.ts` exists with `requireWorkspaceRole()` exported
- [ ] `requireWorkspaceRole()` throws 404 (NotFoundError), never 403 (ForbiddenError)
- [ ] Calls Convex `organizationMembers.hasAccess` query — no local caching
- [ ] agents/route.ts: TODO comment replaced with requireWorkspaceRole() call
- [ ] `/api/admin/workspaces` POST route exists for system admin workspace creation
- [ ] middleware.ts bypasses `/api/admin/*` routes (no workspace middleware applied)
- [ ] middleware.ts adds `x-caller-role` header to responses
- [ ] All rbac tests pass: `npm test -- --testPathPattern="rbac"`
- [ ] No test regression: `npm test` shows same or more tests passing vs before
</success_criteria>

<output>
After completion, create `.planning/phases/02-workspace-isolation-rbac/02-04-SUMMARY.md` with:
- rbac.ts API (function signatures)
- Admin route endpoint (method, path, args)
- Middleware changes made
- How existing route tests were preserved (mocking strategy)
- Any deviations from plan
</output>
