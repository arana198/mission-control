---
phase: 02-workspace-isolation-rbac
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-02
files_modified:
  - backend/convex/tasks.ts
  - backend/convex/epics.ts
  - backend/convex/activities.ts
  - backend/convex/messages.ts
  - backend/convex/documents.ts
  - backend/convex/decisions.ts
  - backend/convex/notifications.ts
  - backend/convex/wiki.ts
  - backend/convex/taskComments.ts
  - backend/convex/executionLog.ts
  - backend/convex/workspaces.ts
  - backend/convex/__tests__/workspace-isolation.test.ts
autonomous: true
requirements:
  - WS-02
  - WS-05

must_haves:
  truths:
    - "All workspace-scoped queries use workspaceQuery builder (not raw query)"
    - "All workspace-scoped mutations use workspaceMutation or adminMutation builder (not raw mutation)"
    - "Queries return ONLY data belonging to the requested workspace"
    - "No workspace-scoped query can return data from a different workspace"
    - "workspaces.getAll is replaced with getMyWorkspaces filtered by membership"
  artifacts:
    - path: "backend/convex/tasks.ts"
      provides: "Workspace-isolated task queries and mutations"
      contains: "workspaceQuery"
    - path: "backend/convex/workspaces.ts"
      provides: "getMyWorkspaces query filtered by membership"
      exports: ["getMyWorkspaces"]
    - path: "backend/convex/__tests__/workspace-isolation.test.ts"
      provides: "Integration tests verifying isolation boundaries"
      min_lines: 80
  key_links:
    - from: "backend/convex/tasks.ts"
      to: "backend/convex/functions.ts"
      via: "import workspaceQuery, workspaceMutation"
      pattern: "import.*workspaceQuery.*from.*functions"
    - from: "backend/convex/workspaces.ts"
      to: "backend/convex/organizationMembers.ts"
      via: "membership query for getMyWorkspaces"
      pattern: "organizationMembers"
---

<objective>
Migrate all workspace-scoped Convex functions from raw `query`/`mutation` to workspace-scoped builders (`workspaceQuery`/`workspaceMutation`/`adminMutation`). Replace `workspaces.getAll` with membership-filtered `getMyWorkspaces`.

Purpose: This is the core enforcement step for WS-02 (workspace data isolation) and WS-05 (users see only assigned workspaces). After this plan, it is structurally impossible for a workspace-scoped query to return data outside its workspace boundary.

Output: All 10+ workspace-scoped Convex files migrated to use builders. New `getMyWorkspaces` query. Integration tests verifying isolation.
</objective>

<execution_context>
@/Users/arana/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arana/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-workspace-isolation-rbac/02-RESEARCH.md
@.planning/phases/02-workspace-isolation-rbac/02-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 outputs (workspaceQuery/workspaceMutation builders) -->

From backend/convex/functions.ts (created in Plan 01):
```typescript
export const workspaceQuery = customQuery(query, {
  args: { workspaceId: v.id("workspaces") },
  input: async (ctx, { workspaceId }) => {
    const workspace = await ctx.db.get(workspaceId);
    if (!workspace) throw new Error("Workspace not found");
    return { ctx: { workspace, workspaceId }, args: {} };
  },
});

export const workspaceMutation = customMutation(mutation, {
  args: { workspaceId: v.id("workspaces") },
  input: async (ctx, { workspaceId }) => { /* same pattern */ },
});

export const adminMutation = customMutation(mutation, {
  args: { workspaceId: v.id("workspaces"), userId: v.string() },
  input: async (ctx, { workspaceId, userId }) => {
    /* verifies workspace + admin membership */
  },
});
```

Migration pattern -- BEFORE:
```typescript
import { query, mutation } from "./_generated/server";

export const getAllTasks = query({
  args: { workspaceId: convexVal.id("workspaces") },
  handler: async (ctx, { workspaceId }) => {
    return ctx.db.query("tasks")
      .withIndex("by_workspace", q => q.eq("workspaceId", workspaceId))
      .collect();
  },
});
```

Migration pattern -- AFTER:
```typescript
import { workspaceQuery, workspaceMutation } from "./functions";

export const getAllTasks = workspaceQuery({
  args: {},  // workspaceId consumed by builder
  handler: async (ctx, args) => {
    // ctx.workspaceId injected and verified by builder
    return ctx.db.query("tasks")
      .withIndex("by_workspace", q => q.eq("workspaceId", ctx.workspaceId))
      .collect();
  },
});
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getMyWorkspaces and migrate core data files</name>
  <files>
    backend/convex/workspaces.ts
    backend/convex/tasks.ts
    backend/convex/epics.ts
    backend/convex/activities.ts
    backend/convex/messages.ts
  </files>
  <action>
**Step 1: Add getMyWorkspaces to workspaces.ts**

Add a new query that replaces `getAll` with membership-filtered results:

```typescript
import { query } from "./_generated/server";

/**
 * Get workspaces the user has membership in (replaces unfiltered getAll)
 * Requires: userId to filter by membership
 */
export const getMyWorkspaces = query({
  args: { userId: convexVal.string() },
  handler: async (ctx, { userId }) => {
    // Get all memberships for this user
    const memberships = await ctx.db
      .query("organizationMembers")
      .withIndex("by_user", (q: any) => q.eq("userId", userId))
      .collect();

    // Fetch workspace for each membership
    const workspaces = await Promise.all(
      memberships
        .filter((m) => m.workspaceId != null)
        .map(async (m) => {
          const ws = await ctx.db.get(m.workspaceId!);
          return ws ? { ...ws, role: m.role } : null;
        })
    );

    return workspaces
      .filter((w): w is NonNullable<typeof w> => w !== null)
      .sort((a, b) => a.name.localeCompare(b.name));
  },
});
```

**Keep `getAll` for now** (mark it with `@deprecated` JSDoc) -- frontend will be migrated in Plan 04. Do NOT delete it.

**Step 2: Migrate tasks.ts to workspaceQuery/workspaceMutation**

In `backend/convex/tasks.ts`:

1. Change import: Replace `import { query, mutation } from "./_generated/server"` with `import { workspaceQuery, workspaceMutation } from "./functions"` and keep `import { query, mutation } from "./_generated/server"` for any non-workspace-scoped functions.

2. Migrate each workspace-scoped query:
   - Find all queries that accept `workspaceId` arg
   - Change from `query({ args: { workspaceId: v.id("workspaces"), ... } })` to `workspaceQuery({ args: { ... } })`
   - Replace `args.workspaceId` with `ctx.workspaceId` in handler body
   - Keep the `by_workspace` index usage

3. Migrate each workspace-scoped mutation similarly.

4. Leave non-workspace-scoped functions (like `getById` that take only a task ID) using raw `query`/`mutation` -- these are not workspace-scoped.

**Step 3: Migrate epics.ts, activities.ts, messages.ts**

Apply the same migration pattern to each file:

For each file:
1. Add import of `workspaceQuery`/`workspaceMutation` from `./functions`
2. Identify queries/mutations that accept `workspaceId`
3. Migrate to builder pattern (remove `workspaceId` from args, use `ctx.workspaceId`)
4. Keep non-workspace-scoped functions as-is

**Migration checklist per file:**
- `epics.ts`: Queries that filter by workspace → workspaceQuery
- `activities.ts`: Activity queries by workspace → workspaceQuery; activity creation → workspaceMutation
- `messages.ts`: Message queries by workspace → workspaceQuery; message creation → workspaceMutation

**IMPORTANT:** The `workspaceQuery` builder automatically adds `workspaceId` to the function args. Callers will still pass `workspaceId` -- it's consumed by the builder before reaching the handler. The handler receives `ctx.workspaceId` instead of `args.workspaceId`.

**IMPORTANT:** If a query/mutation has BOTH `workspaceId` and other args, only remove `workspaceId` from the function's `args` object. Keep all other args.

**IMPORTANT:** Some mutations may use `wrapConvexHandler` from `../lib/errors`. The `workspaceMutation` builder and `wrapConvexHandler` are separate concerns. If a mutation needs both workspace validation AND error wrapping, you can either:
- (a) Use `workspaceMutation` and handle errors inside the handler, OR
- (b) Keep `wrapConvexHandler` and use `workspaceMutation` (they compose)
Choose (a) for simplicity. The builder already throws on invalid workspace.
  </action>
  <verify>
    <automated>cd /Users/arana/dev/ankit/mission-control && npm test -- --testPathPattern="businesses|epics|activities|messages"</automated>
  </verify>
  <done>
    - getMyWorkspaces query returns only workspaces user has membership in
    - tasks.ts workspace-scoped functions use workspaceQuery/workspaceMutation
    - epics.ts workspace-scoped functions use workspaceQuery/workspaceMutation
    - activities.ts workspace-scoped functions use workspaceQuery/workspaceMutation
    - messages.ts workspace-scoped functions use workspaceQuery/workspaceMutation
    - All existing tests pass (callers still pass workspaceId -- builder consumes it)
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining files and write isolation tests</name>
  <files>
    backend/convex/documents.ts
    backend/convex/decisions.ts
    backend/convex/notifications.ts
    backend/convex/wiki.ts
    backend/convex/taskComments.ts
    backend/convex/executionLog.ts
    backend/convex/__tests__/workspace-isolation.test.ts
    backend/convex/__tests__/workspace-membership.test.ts
  </files>
  <action>
**Step 1: Migrate remaining workspace-scoped files**

Apply the same migration pattern from Task 1 to:
- `documents.ts` — document queries/mutations by workspace
- `decisions.ts` — decision queries/mutations by workspace
- `notifications.ts` — notification queries/mutations by workspace
- `wiki.ts` — wiki page queries/mutations by workspace
- `taskComments.ts` — comment queries/mutations by workspace
- `executionLog.ts` — execution log queries by workspace

For each file:
1. Add `import { workspaceQuery, workspaceMutation } from "./functions"`
2. Migrate workspace-scoped queries to `workspaceQuery` builder
3. Migrate workspace-scoped mutations to `workspaceMutation` builder
4. Use `ctx.workspaceId` in handler instead of `args.workspaceId`

**Files that should NOT be migrated** (remain on raw query/mutation):
- `agents.ts` — Agents are global (shared across workspaces). Keep raw query/mutation.
- `organizationMembers.ts` — Membership management operates across workspace boundary. Keep raw query/mutation.
- `workspaces.ts` — Workspace CRUD itself can't use workspace-scoped builders (chicken-egg). Keep raw query/mutation except for workspace-internal operations. **CRITICAL: Preserve `getWorkspaceById` export** — Plan 02-04 depends on it for `validateWorkspaceAccess` in frontend API routes.
- `gateways.ts` — Gateway connections are system-level, not workspace-scoped.
- `migrations.ts` — System-level operations.
- `admin.ts`, `debug.ts` — System admin functions.

**Step 2: Write workspace isolation integration tests**

Create `backend/convex/__tests__/workspace-isolation.test.ts`:

Since we can't run the actual Convex runtime in tests, test the builder's input validation by mocking the builder and verifying that:

1. **Workspace existence check:** Mock a `workspaceQuery` call where `ctx.db.get(workspaceId)` returns null → verify it throws "Workspace not found"

2. **workspaceId injection:** Mock a `workspaceQuery` call where workspace exists → verify handler receives `ctx.workspaceId` matching the passed ID

3. **getMyWorkspaces filtering:** Mock the membership query to return memberships for 2 of 3 workspaces → verify only those 2 workspaces are returned

4. **getMyWorkspaces empty membership:** Mock membership query returning empty → verify empty array returned

5. **adminMutation role check:** Mock membership with "member" role → verify throws "Admin access required"

6. **adminMutation with owner (legacy):** Mock membership with "owner" role → verify succeeds (owner >= admin level)

7. **Cross-workspace data isolation conceptual test:** Create a test that documents the contract: "workspaceQuery handler can only access data via ctx.workspaceId, preventing cross-workspace leaks"

Test structure should follow existing patterns in `backend/convex/__tests__/businesses.test.ts`.

**Step 2b: Create workspace membership tests (WS-05)**

Create `backend/convex/__tests__/workspace-membership.test.ts`:

This test file covers WS-05 (user sees only assigned workspaces) and the membership filtering logic:

1. **getMyWorkspaces returns only member workspaces:** Mock 3 workspaces, user has membership in 2 → returns only those 2
2. **getMyWorkspaces includes role from membership:** Each returned workspace has `role` field matching membership
3. **getMyWorkspaces with no memberships:** Returns empty array
4. **getMyWorkspaces sorts by name:** Verify alphabetical sort order
5. **getMyWorkspaces skips null workspaceId memberships:** Membership with null workspaceId → filtered out
6. **getMyWorkspaces skips deleted workspaces:** Membership exists but workspace deleted → filtered out

**Step 2c: Verify getWorkspaceById export preserved**

After all migrations to `workspaces.ts`, verify that `getWorkspaceById` is still exported:

```bash
# MUST find getWorkspaceById — Plan 02-04 depends on it
grep "export const getWorkspaceById" backend/convex/workspaces.ts
```

If `getWorkspaceById` was accidentally removed or renamed during migration, restore it:
```typescript
export const getWorkspaceById = query({
  args: { workspaceId: convexVal.id("workspaces") },
  handler: async (ctx, { workspaceId }) => {
    return await ctx.db.get(workspaceId);
  },
});
```

This function is consumed by `frontend/lib/api/workspaceContext.ts` via `api.workspaces.getWorkspaceById` (Plan 02-04).

**Step 3: Verify no raw query/mutation imports remain in migrated files**

After migration, verify:
```bash
# Should return 0 results for migrated files
grep -l 'from "./_generated/server"' backend/convex/tasks.ts backend/convex/epics.ts backend/convex/activities.ts backend/convex/messages.ts backend/convex/documents.ts backend/convex/decisions.ts backend/convex/notifications.ts backend/convex/wiki.ts backend/convex/taskComments.ts backend/convex/executionLog.ts
```

NOTE: Some files may still need raw `query` or `mutation` for non-workspace-scoped functions alongside the workspace-scoped ones. That's acceptable -- the key is that workspace-scoped functions use the builders.
  </action>
  <verify>
    <automated>cd /Users/arana/dev/ankit/mission-control && npm test -- --testPathPattern="workspace-isolation|workspace-membership|documents|decisions|notifications|wiki|taskComments|executionLog" && grep "export const getWorkspaceById" backend/convex/workspaces.ts</automated>
  </verify>
  <done>
    - All 6 remaining files migrated to workspace-scoped builders
    - workspace-isolation.test.ts passes with 7+ tests covering isolation boundaries
    - workspace-membership.test.ts passes with 6+ tests covering WS-05 membership filtering
    - getWorkspaceById export verified present in workspaces.ts (required by Plan 02-04)
    - No workspace-scoped query/mutation in migrated files uses raw query/mutation
    - Non-workspace-scoped files (agents, gateways, etc.) untouched
    - All existing tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# All tests pass (no regressions from migration)
cd /Users/arana/dev/ankit/mission-control && npm test

# TypeScript compiles
cd /Users/arana/dev/ankit/mission-control && npm run build

# Workspace isolation tests specifically
npm test -- --testPathPattern=workspace-isolation

# Workspace membership tests (WS-05)
npm test -- --testPathPattern=workspace-membership

# Verify getWorkspaceById export preserved (required by Plan 02-04)
grep "export const getWorkspaceById" backend/convex/workspaces.ts

# Verify migration coverage (workspace-scoped files use functions.ts)
grep -l "workspaceQuery\|workspaceMutation" backend/convex/tasks.ts backend/convex/epics.ts backend/convex/activities.ts backend/convex/messages.ts backend/convex/documents.ts backend/convex/decisions.ts backend/convex/notifications.ts backend/convex/wiki.ts backend/convex/taskComments.ts backend/convex/executionLog.ts
```
</verification>

<success_criteria>
- 10+ workspace-scoped Convex files migrated to workspaceQuery/workspaceMutation
- getMyWorkspaces query returns only workspaces user belongs to
- getAll marked as @deprecated (not deleted -- frontend migration in Plan 04)
- getWorkspaceById export preserved in workspaces.ts (consumed by Plan 02-04)
- Isolation integration tests pass (workspace-isolation.test.ts)
- Membership filtering tests pass (workspace-membership.test.ts)
- All existing tests pass (no regressions)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-workspace-isolation-rbac/02-03-SUMMARY.md`
</output>
