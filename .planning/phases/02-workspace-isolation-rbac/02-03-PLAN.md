---
phase: 02-workspace-isolation-rbac
plan: 03
type: execute
wave: 3
depends_on:
  - 02-01
  - 02-02
files_modified:
  - backend/convex/agents.ts
  - backend/convex/tasks.ts
  - backend/convex/epics.ts
  - backend/convex/executions.ts
  - backend/convex/notifications.ts
  - backend/convex/activities.ts
  - backend/convex/organizationMembers.ts
  - backend/convex/__tests__/requireRole.integration.test.ts
autonomous: true
requirements:
  - WS-02  # Partial: agents/tasks/epics only. Executions table isolation deferred — see scoping note below.
  - WS-05
  - WS-06

must_haves:
  truths:
    - "All Convex mutations that write workspace-scoped data (agents, tasks, epics) call requireRole() before any DB writes"
    - "At minimum: agents.create/update/delete, tasks.create/update/delete, epics.create/update/delete all enforce viewer+ on reads and collaborator+ on writes"
    - "executions table mutations are NOT guarded in this plan — deferred to Phase 6 per scoping note in objective"
    - "Permission failure logging: failed requireRole calls log to activities table with type='permission_denied'"
    - "Permission failure rate limiting: after 5 failures per userId+workspaceId in 60s, subsequent requireRole calls still return 404 (no 429) but the failure is still logged"
    - "requireAdmin() and requireOwner() deprecated functions removed or updated to call requireRole()"
    - "activities.ts marks admin-originated actions with isAdminAction=true per locked decision"
  artifacts:
    - path: "backend/convex/agents.ts"
      provides: "requireRole() guard on all mutations (create/update/delete/deactivate)"
      contains: "requireRole"
    - path: "backend/convex/tasks.ts"
      provides: "requireRole() guard on mutations"
      contains: "requireRole"
    - path: "backend/convex/epics.ts"
      provides: "requireRole() guard on mutations"
      contains: "requireRole"
    - path: "backend/convex/__tests__/requireRole.integration.test.ts"
      provides: "Integration tests verifying permission gates across multiple Convex functions"
      min_lines: 60
  key_links:
    - from: "agents.ts create mutation"
      to: "requireRole(ctx, workspaceId, callerId, 'collaborator')"
      via: "callerId arg added to all mutating functions"
      pattern: "requireRole.*collaborator"
    - from: "permission failure"
      to: "activities insert"
      via: "catch block in requireRole or wrapper"
      pattern: "type.*permission_denied"
    - from: "permission failure rate limit"
      to: "checkRateLimitSilent"
      via: "perm_fail:userId:workspaceId key, 5 failures per 60s"
      pattern: "perm_fail.*checkRateLimitSilent"
---

<objective>
Wire requireRole() into all workspace-scoped Convex mutations for agents, tasks, and epics; add permission failure logging and rate limiting.

Purpose: Defense-in-depth requires that both the API middleware layer (Plan 04) AND the Convex backend layer enforce roles. This plan completes the backend half. If middleware is bypassed, Convex still rejects unauthorized writes.

Output: requireRole() called in agents/tasks/epics mutations, permission failures logged and rate-limited, deprecated requireAdmin/requireOwner removed.

**WS-02 Scoping Note — Executions Table Isolation Deferred to Phase 6:**

RESEARCH.md flagged `executions.ts` as having `workspaceId: v.optional(v.id("workspaces"))` — an optional field that creates an isolation bypass where execution records can exist without workspace binding. Enforcing workspaceId filtering on executions mutations is deferred to Phase 6 (when crons/workflows are built) for these reasons:

1. Executions are created by workflow steps and cron triggers, neither of which exists yet in Phase 2.
2. Adding a required `workspaceId` guard to executions mutations now would require also fixing the schema (make workspaceId required) and all callers — scope that belongs to Phase 6's workflow schema work.
3. WS-02 partial coverage (agents/tasks/epics) is sufficient for Phase 2 goals; executions are an internal engine concern, not a user-facing data boundary at this stage.

Phase 6 plan must include: add requireRole guard to executions create/update/delete mutations, enforce workspaceId as required in executions schema, and filter all executions queries by workspaceId.
</objective>

<execution_context>
@/Users/arana/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-workspace-isolation-rbac/02-CONTEXT.md
@.planning/phases/02-workspace-isolation-rbac/02-RESEARCH.md
@.planning/phases/02-workspace-isolation-rbac/02-01-SUMMARY.md
@.planning/phases/02-workspace-isolation-rbac/02-02-SUMMARY.md

<interfaces>
<!-- Types from Plans 01-02 the executor uses -->

From backend/convex/organizationMembers.ts (Plan 01 output):
```typescript
export async function requireRole(
  ctx: any,
  workspaceId: Id<"workspaces">,
  userId: string,
  requiredRole: UserRole  // "admin" | "agent" | "collaborator" | "viewer"
): Promise<void>
// Throws ConvexError("NOT_FOUND") on failure — never throws 403

export type UserRole = "admin" | "agent" | "collaborator" | "viewer";
```

From backend/convex/utils/rateLimit.ts (existing):
```typescript
export async function checkRateLimitSilent(
  ctx: any,
  key: string,      // "perm_fail:userId:workspaceId"
  maxCalls: number, // 5
  windowMs: number  // 60_000
): Promise<boolean>
```

Role assignment per operation type:
- READ mutations (list, get): require "viewer" (lowest — agents and above can read)
- WRITE mutations (create, update): require "collaborator"
- ADMIN mutations (delete, deactivate, assign): require "admin"

From locked decisions (CONTEXT.md):
- Permission failures always return 404, never 403
- Rate limiting on failures: 5 failures → 1-min cooldown (but still 404, not 429)
- Admin action logging: mark admin actions with isAdminAction=true
- No cross-workspace queries
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add requireRole() to agents, tasks, and epics mutations</name>
  <files>
    backend/convex/agents.ts
    backend/convex/tasks.ts
    backend/convex/epics.ts
  </files>
  <action>
For each of the three files, follow this pattern:

**Step 1: Add import at top of each file:**
```typescript
import { requireRole } from "./organizationMembers";
```

**Step 2: Add `callerId` arg to all mutating functions** (any mutation that writes/deletes). Read mutations (queries) do not need role checks since data isolation is handled by workspaceId filtering.

For each mutation, add:
```typescript
callerId: convexVal.string(), // The agent/user making the request
```

**Step 3: Add requireRole call as FIRST operation in each mutation handler** (before any DB reads/writes):

For CREATE operations (agents.create, tasks.create, epics.create):
```typescript
await requireRole(ctx, args.workspaceId, args.callerId, "collaborator");
```

For UPDATE operations (agents.update, tasks.update, epics.update):
```typescript
await requireRole(ctx, args.workspaceId, args.callerId, "collaborator");
```

For DELETE/DEACTIVATE operations (agents.deactivate/remove, tasks.delete, epics.delete):
```typescript
await requireRole(ctx, args.workspaceId, args.callerId, "admin");
```

**IMPORTANT constraints:**
- If a mutation doesn't currently accept `workspaceId`, look it up first: `const record = await ctx.db.get(args.id); const wsId = record.workspaceId;`
- If `workspaceId` is optional on a record (legacy), skip the role check if workspaceId is undefined (legacy data access)
- Do NOT add requireRole to internal utility functions or functions called from other Convex functions (only add to functions called from API routes)

**agents.ts specific:** The file has mutations like `updateStatus`, `updateCurrentTask`, `recordHeartbeat` — these are internal agent-to-agent calls, skip requireRole on them. Add it to `create`, `update`, `deactivate`, `remove`.

**tasks.ts specific:** Add to `create`, `update`, `updateStatus`, `delete`. Skip internal utility mutations.

**epics.ts specific:** Add to `create`, `update`, `delete`.
  </action>
  <verify>
    <automated>grep -c "requireRole" /Users/arana/dev/ankit/mission-control/backend/convex/agents.ts && grep -c "requireRole" /Users/arana/dev/ankit/mission-control/backend/convex/tasks.ts && grep -c "requireRole" /Users/arana/dev/ankit/mission-control/backend/convex/epics.ts</automated>
  </verify>
  <done>agents.ts, tasks.ts, and epics.ts each contain multiple requireRole() calls (at least 3 per file). Build passes without TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Permission failure logging, rate limiting, admin action marking + integration tests</name>
  <files>
    backend/convex/organizationMembers.ts
    backend/convex/activities.ts
    backend/convex/__tests__/requireRole.integration.test.ts
  </files>
  <action>
**Part A — Enhance requireRole() to log failures and rate-limit (organizationMembers.ts):**

Update `requireRole()` function to add failure logging and rate limiting. Import the rateLimit utility:
```typescript
import { checkRateLimitSilent } from "./utils/rateLimit";
```

Wrap the existing logic with permission failure handling:
```typescript
export async function requireRole(
  ctx: any,
  workspaceId: Id<"workspaces">,
  userId: string,
  requiredRole: UserRole
): Promise<void> {
  // Check system admin bypass (unchanged from Plan 01)
  const sysAdmin = await ctx.db
    .query("systemAdmins")
    .withIndex("by_user", (q: any) => q.eq("userId", userId))
    .first();
  if (sysAdmin) return;

  const member = await ctx.db
    .query("organizationMembers")
    .withIndex("by_workspace_user", (q: any) =>
      q.eq("workspaceId", workspaceId).eq("userId", userId)
    )
    .first();

  let permissionDenied = false;

  if (!member) {
    permissionDenied = true;
  } else {
    const effectiveRole = (member.userRole ?? mapLegacyRole(member.role)) as UserRole;
    if (!hasRequiredRole(effectiveRole, requiredRole)) {
      permissionDenied = true;
    }
  }

  if (permissionDenied) {
    // Rate limit check: 5 failures per user+workspace per minute (per locked decision)
    // Note: we do NOT return 429 even if rate limited — still return 404
    // The rate limiting is for logging/detection, not changing the response
    const failKey = `perm_fail:${userId}:${workspaceId}`;
    const underLimit = await checkRateLimitSilent(ctx, failKey, 5, 60_000);

    // Log failure to activities table (always log, even when rate limit exceeded)
    // This creates the audit trail per locked decision
    await ctx.db.insert("activities", {
      type: "permission_denied",
      agentId: undefined,
      workspaceId,
      metadata: JSON.stringify({
        userId,
        requiredRole,
        rateLimited: !underLimit,
        timestamp: Date.now(),
      }),
      timestamp: Date.now(),
    });

    // Always 404, never 403 (locked decision: security through obscurity)
    throw new ConvexError("NOT_FOUND");
  }
}
```

IMPORTANT: Check the activities table schema first (`grep -A20 "activities:" backend/convex/schema.ts`) and adapt the insert fields to match the actual schema. Do not create fields that don't exist in the schema.

**Part B — Admin action marking in activities.ts:**

Find where activities are created (likely in activities.ts or a logger utility). Add an `isAdminAction` boolean field to the activities schema if not present:
- In schema.ts activities table: `isAdminAction: convexVal.optional(convexVal.boolean())`
- In the activity logger utility, detect if the actor is a system admin or workspace admin and set `isAdminAction: true`

**Part C — Remove deprecated requireAdmin/requireOwner:**

In `organizationMembers.ts`, update `requireAdmin()` and `requireOwner()` to delegate to `requireRole()`:
```typescript
/** @deprecated Use requireRole(ctx, workspaceId, userId, "admin") instead */
export async function requireAdmin(ctx: any, workspaceId: Id<"workspaces">, userId: string): Promise<void> {
  await requireRole(ctx, workspaceId, userId, "admin");
}

/** @deprecated Use requireRole(ctx, workspaceId, userId, "admin") instead */
export async function requireOwner(ctx: any, workspaceId: Id<"workspaces">, userId: string): Promise<void> {
  await requireRole(ctx, workspaceId, userId, "admin"); // owner → admin in new hierarchy
}
```

**Part D — Integration tests:**

Create `backend/convex/__tests__/requireRole.integration.test.ts`:

```typescript
describe('requireRole integration', () => {
  it('logs permission_denied activity when access denied')
  it('tracks rate limit: 6th failure in 60s still returns NOT_FOUND (not 429)')
  it('passes for system admin without membership record')
  it('passes for admin role member on admin-required operation')
  it('fails for collaborator role member on admin-required operation')
  it('isAdminAction=true set when admin performs action in activities')
})
```

Run: `npm test -- --testPathPattern="requireRole|organizationMembers"`
  </action>
  <verify>
    <automated>npm test -- --testPathPattern="requireRole|organizationMembers" 2>&1 | grep -E "PASS|FAIL|Tests:"</automated>
  </verify>
  <done>requireRole() logs permission failures to activities. Rate limiting checked but response always stays 404. requireAdmin/requireOwner delegate to requireRole. Activities have isAdminAction field. All integration tests pass.</done>
</task>

</tasks>

<verification>
Run targeted suite:
```bash
npm test -- --testPathPattern="requireRole|organizationMembers|agents|tasks|epics"
```
Expected: All tests PASS.

Count requireRole calls across backend:
```bash
grep -c "requireRole" /Users/arana/dev/ankit/mission-control/backend/convex/agents.ts
grep -c "requireRole" /Users/arana/dev/ankit/mission-control/backend/convex/tasks.ts
grep -c "requireRole" /Users/arana/dev/ankit/mission-control/backend/convex/epics.ts
```
Expected: Each file has at least 3 requireRole calls.

Build check:
```bash
npm run build 2>&1 | grep -c "error TS"
```
Expected: 0 errors.
</verification>

<success_criteria>
- [ ] agents.ts: requireRole() called on create, update, deactivate, remove mutations
- [ ] tasks.ts: requireRole() called on create, update, updateStatus, delete mutations
- [ ] epics.ts: requireRole() called on create, update, delete mutations
- [ ] requireRole() logs `permission_denied` to activities table on every failure
- [ ] Permission failures are rate-limited at 5/minute per user+workspace (but response stays 404)
- [ ] requireAdmin() and requireOwner() deprecated and delegate to requireRole()
- [ ] isAdminAction field added to activities schema and populated for admin actions
- [ ] All requireRole integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-workspace-isolation-rbac/02-03-SUMMARY.md` with:
- Files modified and what changed in each
- Permission failure logging approach (activities schema fields used)
- List of mutations that now have requireRole() guards
- Any deviations from plan
</output>
