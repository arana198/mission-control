---
phase: 01-rest-api-foundation
task: 7
total_tasks: 10
status: in_progress
last_updated: 2026-02-26T21:31:00Z
---

<current_state>
**WAVE 3 ROUTE MIGRATION IN PROGRESS** — Iteration 5 Complete

- Completed: Waves 1-2 (foundation utilities) + Route helpers + 7 agent routes + jest fix
- Current: Task 3.1 (Batch 1 Agent Routes) — 7 of 13 routes migrated ✅ (54% progress)
- Status: Production-ready code, jest Request polyfill FIXED ✅
- Test baseline: 2624/2624 passing (all routes tested, jest environment fixed)

</current_state>

<completed_work>

### ✅ Waves 1-2: Foundation Complete (184 tests passing)
- Rate limiting, error responses, pagination, auth middleware, OpenAPI spec

### ✅ Wave 3 Infrastructure (Iteration 2)
- Task 3.0: `frontend/lib/api/routeHelpers.ts` (300 lines, 33 tests)
- Task 3.0: `ROUTE-MIGRATION-AUDIT.md` (34 routes categorized into 3 batches)

### ✅ Jest Request Polyfill (Iteration 5 - BLOCKING FIX)
- Created `jest.setup.js` with Request/Response global polyfills
- Updated `jest.config.js` to use setupFilesAfterEnv
- Refactored route handlers to lazy-load ConvexHttpClient for test mocking
- **Result:** All tests now pass, no more "Request is not defined" errors ✅

### ✅ Wave 3 Batch 1 Agent Routes (Iterations 3-5)

**Route 1/13: `/api/v1/workspaces/{wsId}/agents` (GET/POST)**
- List agents with cursor pagination (GET)
- Register new agent (POST)
- 290-line handler + 470-line test suite (13 test cases)
- Status: ✅ Complete and production-ready

**Route 2/13: `/api/v1/workspaces/{wsId}/agents/{agentId}` (GET/PUT/DELETE)**
- Retrieve agent details (GET)
- Update agent properties (PUT)
- Remove agent from workspace (DELETE)
- 320-line handler + 420-line test suite (11 test cases)
- Status: ✅ Complete and production-ready

**Route 3/13: `/api/v1/workspaces/{wsId}/agents/{agentId}/heartbeat` (POST)**
- Agent heartbeat with optional status and metrics
- Updates last active timestamp
- 200-line handler + 350-line test suite (10 test cases)
- Status: ✅ Complete and production-ready

**Route 4/13: `/api/v1/workspaces/{wsId}/agents/{agentId}/poll` (GET)**
- Poll for pending work/tasks with long-polling support
- Supports timeout and filter parameters
- 180-line handler + 320-line test suite (10 test cases)
- Status: ✅ Complete and production-ready

**Route 5/13: `/api/v1/workspaces/{wsId}/agents/{agentId}/rotate-key` (POST)**
- Rotate API key for security
- Generates new UUID, 24-hour grace period for old key
- 160-line handler + 330-line test suite (10 test cases)
- Status: ✅ Complete and production-ready

**Route 6/13: `/api/v1/workspaces/{wsId}/agents/{agentId}/tasks` (GET/POST)**
- List agent tasks with pagination and status filter (GET)
- Create new task assigned to agent (POST)
- 350-line handler + 380-line test suite
- Status: ✅ Complete and production-ready

**Route 7/13: `/api/v1/workspaces/{wsId}/agents/{agentId}/tasks/{taskId}` (GET)** [NEW]
- Retrieve specific task details including status, progress, metrics
- Handles optional dueDate and metrics fields
- 250-line handler + 300-line test suite (8 test cases) ✅
- Status: ✅ Complete and production-ready

**OpenAPI Documentation:**
- All 7 routes documented in OpenAPI 3.0 spec
- Swagger UI at `/api/docs` includes examples and Try-It-Out

</completed_work>

<remaining_work>

### Wave 3 Batch 1 (6 more routes — ~1-1.5 hours)
- Route 8: `/api/v1/workspaces/{wsId}/agents/{agentId}/tasks/{taskId}` (PUT - update task)
- Routes 9-13: Task comments endpoints (list, create, update, delete)

### Wave 3 Batches 2-3 (20 routes — ~2-3 days)
- Batch 2: Task, Epic, Business routes (10 routes)
- Batch 3: Infrastructure routes (11 routes)

### Wave 4 (Testing & Finalization)
- E2E API contract testing
- Documentation & cleanup

</remaining_work>

<decisions_made>

1. **v1 directory structure:** Routes at `/api/v1/workspaces/[workspaceId]/resource/[resourceId]/action/route.ts`
2. **Dual-path support:** Both `/api/` (legacy) and `/api/v1/` (canonical) work during migration
3. **Error format:** RFC 9457 with unique request IDs for all routes
4. **Auth:** Bearer primary, legacy headers fallback
5. **Pagination:** Cursor-based (from Wave 2 foundation)
6. **Test pattern:** Pure functions in helpers, NextResponse mocking in route tests
7. **Action endpoints:** POST for mutations (heartbeat, rotate-key), GET for queries (poll)
8. **Task creation:** Default priority to "normal", support low/normal/high levels
9. **Jest testing:** Lazy-load Convex client in route handlers, use setupFilesAfterEnv for polyfills

</decisions_made>

<blockers>

✅ **Test Environment Issue - FIXED IN ITERATION 5**
- Added `jest.setup.js` with Request/Response polyfills
- Updated `jest.config.js` with setupFilesAfterEnv
- All route tests now pass without Request errors

</blockers>

<context>

**Architecture Pattern FULLY ESTABLISHED & PROVEN:**

Each route follows identical pattern:
1. Route handler in `/api/v1/workspaces/[wsId]/resource/[resourceId]/action/route.ts`
2. Use routeHelpers for response formatting
3. Add Bearer token auth validation with legacy fallback
4. Extract workspace and resource IDs from URL path
5. Return RFC 9457 format with request ID
6. Lazy-load ConvexHttpClient (for test mocking)
7. Write 8-13 test cases covering happy paths, validation, not found
8. Add route to OpenAPI spec for Swagger documentation

**Route Implementation Time (Iteration 5):**
- Routes 1-2: ~45 min each (establishing pattern)
- Routes 3-6: ~30 min each (pattern refinement)
- Route 7: ~25 min (pattern mastery, jest fix included)
- Routes 8+: ~20-25 min each (predicted)

**Code Metrics:**
- Average route: 250-350 lines of handler code
- Average tests: 300-380 lines of test code
- All routes: RFC 9457 compliant, Bearer token auth, OpenAPI documented, tests passing

**Test Environment:**
- Jest config: jsdom + ts-jest
- Fixed: Request/Response globals via jest.setup.js
- All route tests now passing ✅

</context>

<next_action>

**IMMEDIATE (Next iteration - Route 8):**

1. **Route 8: Update task endpoint**
   - `/api/v1/workspaces/{wsId}/agents/{agentId}/tasks/{taskId}` (PUT)
   - Update task properties (title, description, status, priority, dueDate)
   - Handler: 250 lines | Tests: 320 lines (9 test cases)
   - Estimated: 20-25 min

2. **Routes 9-13: Task comments** (5 routes)
   - Comment endpoints for agent tasks
   - Estimated: 45-60 min for all 5

3. **Total remaining for Batch 1:** 6 routes (~1.5-2 hours)

4. **After Batch 1 completion (estimated 1 more iteration):**
   - Move to Batches 2-3 (20 routes total)
   - Expected completion: 2-3 additional iterations

**Commits completed:** 15 (Iteration 1: 7, Iteration 2: 2, Iteration 3: 2, Iteration 4+: 4)
**Test baseline:** 2624/2624 passing (all routes tested and working)
**Estimated full completion:**
- Batch 1: ~1 more iteration (6 routes remaining)
- Batches 2-3: ~2-3 more iterations (20 routes)
- Total: ~4-5 iterations for Wave 3 complete (all 34 routes)
- Overall phase: ~5-6 iterations total (including Wave 4 finalization)

</next_action>
