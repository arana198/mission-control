# Architecture Diagrams: Mission Control Visual Reference

## 1. Multi-Tenant Architecture & Business Scoping

### System-Level View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MISSION CONTROL                              â”‚
â”‚              Single Instance, Multiple Businesses               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Business A         â”‚  â”‚   Business B         â”‚  â”‚   Business C         â”‚
â”‚  (OpenClaw Inc)      â”‚  â”‚  (TechCorp)          â”‚  â”‚  (StartupXYZ)        â”‚
â”‚                      â”‚  â”‚                      â”‚  â”‚                      â”‚
â”‚  ðŸš€ emoji            â”‚  â”‚  ðŸ”§ emoji            â”‚  â”‚  âš¡ emoji            â”‚
â”‚  slug: openclaw-inc  â”‚  â”‚  slug: techcorp      â”‚  â”‚  slug: startupxyz    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                         â”‚                         â”‚
           â”‚ businessId=b1           â”‚ businessId=b2           â”‚ businessId=b3
           â”‚                         â”‚                         â”‚
           â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SHARED DATABASE                              â”‚
â”‚                  (Single Convex Instance)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GLOBAL TABLES (Shared across all businesses)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  âœ“ businesses (b1, b2, b3, ...)                                â”‚
â”‚    â””â”€ Each business config                                     â”‚
â”‚                                                                 â”‚
â”‚  âœ“ agents (Jarvis, Shuri, Fury, ...)                           â”‚
â”‚    â””â”€ Shared agent squad across all businesses                 â”‚
â”‚                                                                 â”‚
â”‚  âœ“ calendarEvents                                              â”‚
â”‚    â””â”€ Global calendar, accessible to all                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BUSINESS-SCOPED TABLES (Every row has businessId)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  âœ“ tasks (businessId: b1, b2, b3, ...)                         â”‚
â”‚    â””â”€ Indexed by businessId for fast scoping queries           â”‚
â”‚                                                                 â”‚
â”‚  âœ“ epics (businessId: b1, b2, b3, ...)                         â”‚
â”‚    â””â”€ Indexed by businessId for fast scoping queries           â”‚
â”‚                                                                 â”‚
â”‚  âœ“ activities (businessId: b1, b2, b3, ...)                    â”‚
â”‚    â””â”€ Audit trail, indexed by businessId                       â”‚
â”‚                                                                 â”‚
â”‚  âœ“ messages, notifications, etc.                               â”‚
â”‚    â””â”€ All have businessId for isolation                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Query Scoping Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Fetch Tasks for Current Business             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ currentBusinessId = "b1"
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ALL TASKS TABLE                                    â”‚
â”‚  â”œâ”€ Task 1 (businessId: b1) â—„â”€â”€ MATCH              â”‚
â”‚  â”œâ”€ Task 2 (businessId: b1) â—„â”€â”€ MATCH              â”‚
â”‚  â”œâ”€ Task 3 (businessId: b1) â—„â”€â”€ MATCH              â”‚
â”‚  â”œâ”€ Task 4 (businessId: b2) âœ— FILTERED OUT        â”‚
â”‚  â”œâ”€ Task 5 (businessId: b2) âœ— FILTERED OUT        â”‚
â”‚  â”œâ”€ Task 6 (businessId: b3) âœ— FILTERED OUT        â”‚
â”‚  â””â”€ ... (millions of tasks)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Index: by_business["b1"]
                    â”‚ (Fast lookup via index)
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        RETURNED TO USER                             â”‚
â”‚  â”œâ”€ Task 1 (b1)                                    â”‚
â”‚  â”œâ”€ Task 2 (b1)                                    â”‚
â”‚  â””â”€ Task 3 (b1)                                    â”‚
â”‚                                                     â”‚
â”‚  âœ“ No data leak (other businesses' tasks hidden)   â”‚
â”‚  âœ“ Fast query (index-driven)                       â”‚
â”‚  âœ“ Automatic isolation (enforced by code)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### The Cost of Missing businessId Filter

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âœ— DANGEROUS: Query without businessId filter      â”‚
â”‚                                                      â”‚
â”‚   const tasks = await ctx.db.query("tasks")         â”‚
â”‚     .collect();                                      â”‚
â”‚                                                      â”‚
â”‚   Result: ALL TASKS returned                        â”‚
â”‚   â”œâ”€ Business A's tasks                             â”‚
â”‚   â”œâ”€ Business B's tasks â—„â”€â”€ DATA LEAK!              â”‚
â”‚   â”œâ”€ Business C's tasks â—„â”€â”€ DATA LEAK!              â”‚
â”‚   â””â”€ ...                                            â”‚
â”‚                                                      â”‚
â”‚   Impact: User sees other businesses' tasks         â”‚
â”‚           Security breach, legal liability          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âœ“ CORRECT: Query with businessId filter           â”‚
â”‚                                                      â”‚
â”‚   const tasks = await ctx.db                        â”‚
â”‚     .query("tasks")                                 â”‚
â”‚     .withIndex("by_business",                       â”‚
â”‚       (q) => q.eq("businessId", businessId)         â”‚
â”‚     )                                               â”‚
â”‚     .collect();                                      â”‚
â”‚                                                      â”‚
â”‚   Result: ONLY current business's tasks returned    â”‚
â”‚   â”œâ”€ Business A's tasks â—„â”€â”€ CORRECT                 â”‚
â”‚   â””â”€ (Other businesses filtered out)                â”‚
â”‚                                                      â”‚
â”‚   Impact: Data isolation guaranteed                 â”‚
â”‚           Index-fast query performance              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Complete Data Flow: Request to UI

```
USER
  â”‚
  â”‚ (1) Clicks "Create Task" button
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    FRONTEND: React Component                â”‚
â”‚  (src/components/CreateTaskForm.tsx)        â”‚
â”‚                                             â”‚
â”‚  User fills in:                             â”‚
â”‚  - Title: "Fix login bug"                   â”‚
â”‚  - Description: "Users can't login"         â”‚
â”‚  - Priority: "P0"                           â”‚
â”‚  - Assignees: [agentId1, agentId2]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ (2) Form submitted
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    VALIDATION LAYER (Client)                â”‚
â”‚  (lib/validators/taskValidators.ts)         â”‚
â”‚                                             â”‚
â”‚  Zod Schema Validation:                     â”‚
â”‚  â”œâ”€ Title: min 3, max 200 chars âœ“           â”‚
â”‚  â”œâ”€ Description: min 10, max 5000 âœ“         â”‚
â”‚  â”œâ”€ Priority: P0|P1|P2|P3 âœ“                 â”‚
â”‚  â”œâ”€ Assignees: valid agent IDs âœ“            â”‚
â”‚  â””â”€ All required fields present âœ“           â”‚
â”‚                                             â”‚
â”‚  Result: Validated input object             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (3) Valid input confirmed
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    API REQUEST (HTTP POST)                  â”‚
â”‚  POST /api/tasks                            â”‚
â”‚  Content-Type: application/json             â”‚
â”‚                                             â”‚
â”‚  Headers:                                   â”‚
â”‚  â”œâ”€ Authorization: Bearer {token}           â”‚
â”‚  â””â”€ X-Business-Id: b1                       â”‚
â”‚                                             â”‚
â”‚  Body:                                      â”‚
â”‚  {                                          â”‚
â”‚    title: "Fix login bug",                  â”‚
â”‚    description: "Users can't login",        â”‚
â”‚    priority: "P0",                          â”‚
â”‚    assigneeIds: ["a1", "a2"]                â”‚
â”‚  }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (4) API route receives request
           â”‚     (src/app/api/tasks/route.ts)
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    SERVER VALIDATION (Node.js)              â”‚
â”‚  (lib/validators/taskValidators.ts)         â”‚
â”‚                                             â”‚
â”‚  Same Zod validation again:                 â”‚
â”‚  â”œâ”€ Validate title âœ“                        â”‚
â”‚  â”œâ”€ Validate description âœ“                  â”‚
â”‚  â”œâ”€ Validate priority âœ“                     â”‚
â”‚  â”œâ”€ Validate businessId exists âœ“            â”‚
â”‚  â””â”€ Validate user has permission âœ“          â”‚
â”‚                                             â”‚
â”‚  Result: Guaranteed valid input             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (5) Call Convex mutation
           â”‚     (convex/tasks.ts:createTask)
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CONVEX MUTATION                          â”‚
â”‚  (convex/tasks.ts)                          â”‚
â”‚                                             â”‚
â”‚  Steps:                                     â”‚
â”‚  1. Verify business exists                  â”‚
â”‚  2. Apply business logic:                   â”‚
â”‚     - Infer tags from content               â”‚
â”‚     - Set default status = "backlog"        â”‚
â”‚     - Set timestamps                        â”‚
â”‚  3. INSERT into database:                   â”‚
â”‚     â””â”€ taskId returned                      â”‚
â”‚  4. LOG ACTIVITY (audit trail)              â”‚
â”‚  5. RETURN created task                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (6) Insert task record
           â”‚     with businessId scoping
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DATABASE: Tasks Table                    â”‚
â”‚  (Convex persistent storage)                â”‚
â”‚                                             â”‚
â”‚  INSERT:                                    â”‚
â”‚  {                                          â”‚
â”‚    _id: "t123abc",                          â”‚
â”‚    businessId: "b1",       â—„â”€â”€ CRITICAL    â”‚
â”‚    title: "Fix login bug",                  â”‚
â”‚    description: "...",                      â”‚
â”‚    priority: "P0",                          â”‚
â”‚    status: "backlog",                       â”‚
â”‚    assigneeIds: ["a1", "a2"],               â”‚
â”‚    tags: ["bug", "auth"],                   â”‚
â”‚    createdAt: 1708345829,                   â”‚
â”‚    updatedAt: 1708345829                    â”‚
â”‚  }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (7) Log activity record
           â”‚     (Audit trail)
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DATABASE: Activities Table               â”‚
â”‚  (Audit trail for debugging/notifications) â”‚
â”‚                                             â”‚
â”‚  INSERT:                                    â”‚
â”‚  {                                          â”‚
â”‚    _id: "act456def",                        â”‚
â”‚    businessId: "b1",       â—„â”€â”€ SCOPED      â”‚
â”‚    taskId: "t123abc",                       â”‚
â”‚    type: "task_created",                    â”‚
â”‚    actor: "user",                           â”‚
â”‚    actorName: "John Doe",                   â”‚
â”‚    changes: {                               â”‚
â”‚      created: {                             â”‚
â”‚        title: "Fix login bug",              â”‚
â”‚        priority: "P0"                       â”‚
â”‚      }                                      â”‚
â”‚    },                                       â”‚
â”‚    timestamp: 1708345829,                   â”‚
â”‚    ticketNumber: "TASK-001"    â—„â”€â”€ DENORM  â”‚
â”‚  }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (8) Return result to API route
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    API RESPONSE (Success)                   â”‚
â”‚  HTTP 201 Created                           â”‚
â”‚                                             â”‚
â”‚  {                                          â”‚
â”‚    success: true,                           â”‚
â”‚    data: {                                  â”‚
â”‚      _id: "t123abc",                        â”‚
â”‚      title: "Fix login bug",                â”‚
â”‚      status: "backlog",                     â”‚
â”‚      priority: "P0",                        â”‚
â”‚      ...                                    â”‚
â”‚    },                                       â”‚
â”‚    timestamp: 1708345829                    â”‚
â”‚  }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (9) Response received by client
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    FRONTEND: UI Update                      â”‚
â”‚  (React component re-renders)               â”‚
â”‚                                             â”‚
â”‚  Actions:                                   â”‚
â”‚  â”œâ”€ Close modal/form                        â”‚
â”‚  â”œâ”€ Add task to Kanban board                â”‚
â”‚  â”‚  â””â”€ In "Backlog" column (P0)             â”‚
â”‚  â”œâ”€ Show toast: "Task created!"             â”‚
â”‚  â”œâ”€ Refresh activity feed                   â”‚
â”‚  â”‚  â””â”€ Shows "Task created by you"          â”‚
â”‚  â”œâ”€ Update unassigned count                 â”‚
â”‚  â””â”€ Clear form inputs                       â”‚
â”‚                                             â”‚
â”‚  âœ“ User sees immediate feedback             â”‚
â”‚  âœ“ No page reload needed                    â”‚
â”‚  âœ“ Real-time collaboration ready            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (10) Task visible in UI
           â”‚
           â–¼
TASK BOARD (Kanban)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Backlog      â”‚  â”‚ In Progress     â”‚  â”‚     Done        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸ”´ P0           â”‚  â”‚                 â”‚  â”‚                 â”‚
â”‚ Fix login bug   â”‚  â”‚                 â”‚  â”‚                 â”‚
â”‚ Assigned to:    â”‚  â”‚                 â”‚  â”‚                 â”‚
â”‚ â€¢ Jarvis        â”‚  â”‚                 â”‚  â”‚                 â”‚
â”‚ â€¢ Shuri         â”‚  â”‚                 â”‚  â”‚                 â”‚
â”‚ Created now âœ“   â”‚  â”‚                 â”‚  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ACTIVITY FEED

ðŸ“ Task created
   Fix login bug (T-001)
   Created by: You
   Just now

[Can click to view task detail]
```

**Key Points in Data Flow:**
- âœ“ Validation at TWO levels (client + server)
- âœ“ businessId included in every step
- âœ“ Activity logged automatically
- âœ“ UI updated immediately
- âœ“ No data visible from other businesses

---

## 3. Component Composition Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  App Root                                    â”‚
â”‚              (app/layout.tsx)                                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Providers: BusinessProvider, ConvexProvider
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Layout Component                              â”‚
â”‚          (app/(app)/layout.tsx)                              â”‚
â”‚         [Main app container]                                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚                      â”‚
     â–¼              â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Sidebar    â”‚  â”‚   Header     â”‚  â”‚  Main Content    â”‚
â”‚ (Navigation) â”‚  â”‚ (Topbar UI)  â”‚  â”‚  Area            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                   â”‚              â”‚
     â”‚                   â”‚              â”‚
     â–¼                   â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚BusinessSelec-â”‚  â”‚DashboardHeaderâ”‚  â”‚  Page Content   â”‚
â”‚tor (Dropdown)â”‚  â”‚              â”‚  â”‚ (Dynamic)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                 â”‚
                  â”‚ Notificationsâ”‚  â”‚ E.g., Board     â”‚
                  â”‚ (Bell + Panel)â”‚  â”‚ Component       â”‚
                  â”‚              â”‚  â”‚                 â”‚
                  â”‚ Create Task  â”‚  â”‚                 â”‚
                  â”‚ Button       â”‚  â”‚                 â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â”‚                    â”‚
                    â–¼                    â–¼                    â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ TaskFilters â”‚     â”‚ TaskColumns  â”‚     â”‚TaskDetail    â”‚
             â”‚ (Sidebar)   â”‚     â”‚ (Kanban)     â”‚     â”‚ (Modal)      â”‚
             â”‚             â”‚     â”‚              â”‚     â”‚              â”‚
             â”‚ - Status    â”‚     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ - Priority  â”‚           â”‚                    â”‚
             â”‚ - Search    â”‚           â”‚                    â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚          â”‚                    â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â–¼                    â–¼
                         â”‚                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â–¼                   â”‚ â”‚TaskHeaderâ”‚      â”‚Comments  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚(Title,   â”‚      â”‚Section   â”‚
                    â”‚  TaskCard   â”‚         â”‚ â”‚Status)   â”‚      â”‚          â”‚
                    â”‚(Individual) â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ - Mentionâ”‚
                    â”‚             â”‚         â”‚                   â”‚   Agents â”‚
                    â”‚ - Title     â”‚         â”‚                   â”‚ - Show   â”‚
                    â”‚ - Priority  â”‚         â”‚                   â”‚   Thread â”‚
                    â”‚ - Assignees â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ - OnClick   â”‚                    â”‚
                    â”‚   â†’ Opens   â”‚                    â–¼
                    â”‚   Detail    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚TaskActivity  â”‚
                                                 â”‚(Audit trail) â”‚
                                                 â”‚ - Created by â”‚
                                                 â”‚ - Assigned   â”‚
                                                 â”‚ - Updated    â”‚
                                                 â”‚ - Status     â”‚
                                                 â”‚   changes    â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATA SOURCES (Top-down)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Context (React): currentBusiness, businesses             â”‚
â”‚  Hooks (Custom): useTasks(), useActivityFeed()            â”‚
â”‚  Convex (Backend): queries for tasks, activities          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAYOUT COMPONENT (App-wide state)                       â”‚
â”‚  â”œâ”€ Provides BusinessProvider context                    â”‚
â”‚  â”œâ”€ Renders Sidebar, Header, MainContent                 â”‚
â”‚  â””â”€ Passes data down via props/context                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                     â”‚
     â–¼                                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TaskBoard Page  â”‚                          â”‚  ActivityFeed Page â”‚
â”‚ (tasks via hook) â”‚                          â”‚ (activities via    â”‚
â”‚                  â”‚                          â”‚  query)            â”‚
â”‚ Local state:     â”‚                          â”‚                    â”‚
â”‚ â”œâ”€ selected      â”‚                          â”‚ Renders:           â”‚
â”‚ â”œâ”€ filters       â”‚                          â”‚ â”œâ”€ Activity items  â”‚
â”‚ â””â”€ sortBy        â”‚                          â”‚ â”œâ”€ Timestamps      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚ â”œâ”€ Actor names     â”‚
     â”‚                                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                             â”‚
     â”œâ”€ Passes to: TaskColumns                     â”‚
     â”‚   â””â”€ Tasks grouped by status                â”‚
     â”‚      â””â”€ Each card clickable                 â”‚
     â”‚         â””â”€ onSelect handler                 â”‚
     â”‚            â””â”€ Sets selectedTask             â”‚
     â”‚               â””â”€ Renders TaskDetail         â”‚
     â”‚                  â””â”€ Passes task data        â”‚
     â”‚                     â”œâ”€ Renders title       â”‚
     â”‚                     â”œâ”€ Status dropdown      â”‚
     â”‚                     â”œâ”€ Assignees list       â”‚
     â”‚                     â”œâ”€ Comments section     â”‚
     â”‚                     â””â”€ Activity log         â”‚
     â”‚
     â””â”€ Data flows back up via:
        â”œâ”€ Callback handlers (onClick)
        â”œâ”€ Mutations (Convex)
        â””â”€ Activity logging (shows in feed)
```

---

## 4. Query Flow: Schema â†’ Index â†’ Optimization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 1: DEFINE SCHEMA (convex/schema.ts)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  tasks: defineTable({                                       â”‚
â”‚    businessId: convexVal.id("businesses"),  â—„â”€ KEY         â”‚
â”‚    title: convexVal.string(),                              â”‚
â”‚    status: convexVal.string(),                             â”‚
â”‚    priority: convexVal.string(),                           â”‚
â”‚    createdAt: convexVal.number(),                          â”‚
â”‚    updatedAt: convexVal.number(),                          â”‚
â”‚  })                                                         â”‚
â”‚    .index("by_business", ["businessId"])   â—„â”€ INDEX 1     â”‚
â”‚    .index("by_status", ["status"])         â—„â”€ INDEX 2     â”‚
â”‚    .index("by_created", ["createdAt"])     â—„â”€ INDEX 3     â”‚
â”‚                                                             â”‚
â”‚  Purpose:                                                   â”‚
â”‚  â”œâ”€ by_business: Fast lookup for business scoping          â”‚
â”‚  â”œâ”€ by_status: Fast filter by task status                  â”‚
â”‚  â””â”€ by_created: Fast sort by creation time                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Indexes created automatically
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 2: WRITE EFFICIENT QUERY                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  PATTERN A: Single filter (fast - uses 1 index)            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  const tasks = await ctx.db                                â”‚
â”‚    .query("tasks")                                         â”‚
â”‚    .withIndex("by_business", (q) =>                        â”‚
â”‚      q.eq("businessId", businessId)  â—„â”€ INDEX LOOKUP      â”‚
â”‚    )                                                       â”‚
â”‚    .collect();                                             â”‚
â”‚                                                             â”‚
â”‚  PATTERN B: Multiple filters (1 index + memory filter)     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚  const tasks = await ctx.db                                â”‚
â”‚    .query("tasks")                                         â”‚
â”‚    .withIndex("by_business", (q) =>                        â”‚
â”‚      q.eq("businessId", businessId)  â—„â”€ INDEX LOOKUP      â”‚
â”‚    )                                                       â”‚
â”‚    .filter((t) => t.status === "backlog")  â—„â”€ MEMORY       â”‚
â”‚    .collect();                                             â”‚
â”‚                                                             â”‚
â”‚  PATTERN C: Compound filter (if composite index)           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚  .index("by_business_status",                              â”‚
â”‚    ["businessId", "status"]                                â”‚
â”‚  )                                                         â”‚
â”‚  .withIndex("by_business_status", (q) =>                  â”‚
â”‚    q                                                       â”‚
â”‚      .eq("businessId", businessId)  â—„â”€ INDEX              â”‚
â”‚      .eq("status", "backlog")       â—„â”€ INDEX              â”‚
â”‚  )                                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Query executes
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 3: DATABASE EXECUTION                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  âŒ WITHOUT INDEX (Full table scan):                        â”‚
â”‚                                                             â”‚
â”‚  Task 1  Task 2  Task 3  Task 4  Task 5 ... Task 1M       â”‚
â”‚   â”‚       â”‚       â”‚       â”‚       â”‚          â”‚             â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  âœ—            â”‚
â”‚   Check Check Check Check Check ... Check (slow!)         â”‚
â”‚  1ms   + 1ms   + 1ms   + 1ms   + 1ms  +    +              â”‚
â”‚                                             1000ms TOTAL    â”‚
â”‚                                                             â”‚
â”‚  âœ“ WITH INDEX (Direct lookup):                            â”‚
â”‚                                                             â”‚
â”‚  Index Key: "b1"                                           â”‚
â”‚           â†“                                                â”‚
â”‚     [Task 2, Task 5, Task 15, ...]  â—„â”€ Only b1 tasks      â”‚
â”‚           â†“                                                â”‚
â”‚     Return immediately  âœ“ (fast)                          â”‚
â”‚                                                             â”‚
â”‚  Execution time: ~1ms vs ~1000ms = 1000x faster!          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Results returned
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 4: HANDLE RESULTS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Tasks returned to mutation/query handler                  â”‚
â”‚                                                             â”‚
â”‚  Optional transformations:                                  â”‚
â”‚  â”œâ”€ Map to include related data (agents, epic, etc.)       â”‚
â”‚  â”œâ”€ Calculate computed fields (progress %, days left)      â”‚
â”‚  â”œâ”€ Sort results (by priority, by date, by assignee)       â”‚
â”‚  â””â”€ Limit results (pagination: take 20, skip 0)            â”‚
â”‚                                                             â”‚
â”‚  Send to client                                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Query Performance: With vs Without Proper Indexing

```
SCENARIO: Get all tasks for business "b1" (1M total tasks)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ SLOW QUERY (No index, full table scan)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  const tasks = await ctx.db.query("tasks").collect();       â”‚
â”‚                                â–²                            â”‚
â”‚                                â”‚                            â”‚
â”‚                        No businessId filter!                â”‚
â”‚                                                              â”‚
â”‚  Execution:                                                 â”‚
â”‚  â”œâ”€ Scan all 1,000,000 tasks one by one                    â”‚
â”‚  â”œâ”€ Check each: does businessId == "b1"?                   â”‚
â”‚  â”œâ”€ Time: ~1000ms (1 second per million records)           â”‚
â”‚  â””â”€ Result: Returns tasks (but took 1 second)              â”‚
â”‚                                                              â”‚
â”‚  Memory: High (loads all 1M records, filters in memory)    â”‚
â”‚  Cost: Expensive (AWS charges by data scanned)              â”‚
â”‚  Scale: Gets worse as data grows                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ“ FAST QUERY (With index, direct lookup)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  const tasks = await ctx.db                                 â”‚
â”‚    .query("tasks")                                          â”‚
â”‚    .withIndex("by_business", (q) =>                         â”‚
â”‚      q.eq("businessId", "b1")  â—„â”€ Index used!             â”‚
â”‚    )                                                        â”‚
â”‚    .collect();                                              â”‚
â”‚                                                              â”‚
â”‚  Execution:                                                 â”‚
â”‚  â”œâ”€ Use index "by_business" to find "b1"                   â”‚
â”‚  â”œâ”€ Direct access to matching records (~1000 records)      â”‚
â”‚  â”œâ”€ Time: ~1ms (milliseconds, not seconds!)                â”‚
â”‚  â””â”€ Result: Returns tasks quickly                           â”‚
â”‚                                                              â”‚
â”‚  Memory: Low (only loads matching records)                  â”‚
â”‚  Cost: Cheap (only charged for data accessed)              â”‚
â”‚  Scale: Stays fast as data grows                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PERFORMANCE COMPARISON:
â”œâ”€ No Index:  1000ms   = Too slow for user (feels broken)
â”œâ”€ With Index:   1ms   = Instant (feels fast)
â””â”€ Speedup: 1000x faster!
```

---

## 5. Testing Pyramid: Test Distribution

```
                              â–²
                             â”‚ â”‚
                             â”‚ â”‚
                             â”‚Eâ”‚  E2E Tests (Playwright)
                             â”‚2â”‚  - Real browser
                             â”‚Eâ”‚  - Full user workflows
                             â”‚ â”‚  - Click buttons, fill forms
                         â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€
                        â”‚           â”‚  ~100 tests (12 files)
                        â”‚    ~5%    â”‚
                        â”‚           â”‚
                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                              â–²
                             â”‚ â”‚
                             â”‚Iâ”‚  Integration Tests
                             â”‚Tâ”‚  - Test mutations + queries
                             â”‚ â”‚  - Test with mock database
                         â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€
                        â”‚           â”‚  ~200 tests
                        â”‚   ~15%    â”‚
                        â”‚           â”‚
                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                              â–²
                             â”‚ â”‚
                             â”‚Uâ”‚  Unit Tests
                             â”‚Nâ”‚  - Pure functions
                             â”‚Iâ”‚  - Validators, utilities
                             â”‚Tâ”‚  - No database
                         â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€
                        â”‚           â”‚  ~952 tests (80%)
                        â”‚   ~80%    â”‚
                        â”‚           â”‚
                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


BREAKDOWN: Mission Control (Total: 1,252 tests)

â”œâ”€ Unit Tests (~950 tests)
â”‚  â”œâ”€ lib/validators/__tests__/
â”‚  â”‚  â”œâ”€ taskValidators.test.ts          (50+ tests)
â”‚  â”‚  â”œâ”€ agentValidators.test.ts         (30+ tests)
â”‚  â”‚  â””â”€ agentTaskValidators.test.ts     (25+ tests)
â”‚  â”‚
â”‚  â”œâ”€ lib/constants/__tests__/
â”‚  â”‚  â””â”€ taskTransitions.test.ts         (20+ tests)
â”‚  â”‚
â”‚  â”œâ”€ lib/utils/__tests__/
â”‚  â”‚  â”œâ”€ apiResponse.test.ts             (30+ tests)
â”‚  â”‚  â””â”€ logger.test.ts                  (15+ tests)
â”‚  â”‚
â”‚  â”œâ”€ lib/auth/__tests__/
â”‚  â”‚  â””â”€ permissions.test.ts             (25+ tests)
â”‚  â”‚
â”‚  â””â”€ src/components/__tests__/
â”‚     â”œâ”€ BusinessSelector.test.tsx       (30+ tests)
â”‚     â”œâ”€ ActivityFeed.test.tsx           (35+ tests)
â”‚     â””â”€ TaskCard.test.tsx               (40+ tests)
â”‚
â”œâ”€ Integration Tests (~200 tests)
â”‚  â”œâ”€ convex/tasks/__tests__/
â”‚  â”‚  â”œâ”€ mutations.test.ts               (40+ tests)
â”‚  â”‚  â””â”€ core-mutations.test.ts          (35+ tests)
â”‚  â”‚
â”‚  â”œâ”€ convex/agents/__tests__/
â”‚  â”‚  â”œâ”€ register.test.ts                (25+ tests)
â”‚  â”‚  â””â”€ index.test.ts                   (20+ tests)
â”‚  â”‚
â”‚  â”œâ”€ convex/utils/__tests__/
â”‚  â”‚  â”œâ”€ activityLogger.test.ts          (20+ tests)
â”‚  â”‚  â”œâ”€ graphValidation.test.ts         (25+ tests)
â”‚  â”‚  â””â”€ epicTaskSync.test.ts            (20+ tests)
â”‚  â”‚
â”‚  â””â”€ src/app/api/__tests__/
â”‚     â”œâ”€ agents/query-tasks.test.ts      (15+ tests)
â”‚     â””â”€ agents/register.test.ts         (12+ tests)
â”‚
â””â”€ E2E Tests (~100 tests)
   â”œâ”€ e2e/task-management.spec.ts        (9 tests)
   â”œâ”€ e2e/epic-management.spec.ts        (8 tests)
   â”œâ”€ e2e/activity-feed.spec.ts          (11 tests)
   â”œâ”€ e2e/notifications.spec.ts          (10 tests)
   â”œâ”€ e2e/business-management.spec.ts    (10 tests)
   â”œâ”€ e2e/forms-validation.spec.ts       (11 tests)
   â”œâ”€ e2e/responsive-mobile.spec.ts      (13 tests)
   â”œâ”€ e2e/accessibility.spec.ts          (12 tests)
   â”œâ”€ e2e/error-states.spec.ts           (13 tests)
   â”œâ”€ e2e/business-selector.spec.ts      (4 tests)
   â”œâ”€ e2e/dashboard-header.spec.ts       (6 tests)
   â””â”€ e2e/layout.spec.ts                 (7 tests)


TEST COVERAGE STRATEGY:

Unit Tests (80%)
â”œâ”€ Input validation (Zod schemas)
â”œâ”€ Pure function logic (utilities)
â”œâ”€ Error handling
â””â”€ Constants and mappings
â””â”€ âœ“ Fast, isolated, repeatable

Integration Tests (15%)
â”œâ”€ Mutation behavior (with mock DB)
â”œâ”€ Query behavior (index testing)
â”œâ”€ Activity logging (side effects)
â””â”€ Multi-step workflows
â””â”€ âœ“ Tests real business logic

E2E Tests (5%)
â”œâ”€ User workflows (click button â†’ see result)
â”œâ”€ Form submission (validation â†’ submit â†’ success)
â”œâ”€ Navigation (route changes)
â”œâ”€ Business isolation (users can't see other business data)
â”œâ”€ Mobile responsiveness
â”œâ”€ Accessibility (keyboard, ARIA)
â””â”€ âœ“ Tests actual rendering


WHAT EACH TEST LAYER CATCHES:

Unit Tests catch:
âœ“ Logic errors (1 + 1 â‰  3)
âœ“ Validation errors (too short, invalid format)
âœ“ Edge cases (empty arrays, null values)
âœ— Rendering errors (doesn't test UI)
âœ— Component composition (doesn't mount components)
âœ— Integration issues (doesn't call real services)

Integration Tests catch:
âœ“ Mutation side effects (logging activity)
âœ“ Query filtering (businessId scoping)
âœ“ Data consistency (proper updates)
âœ“ Error cases with database
âœ— Rendering errors (still doesn't test UI)
âœ— User workflows (doesn't click buttons)
âœ— Network issues (doesn't use HTTP)

E2E Tests catch:
âœ“ Rendering errors (page actually shows)
âœ“ Component composition (all pieces work together)
âœ“ User workflows (click â†’ result visible)
âœ“ Network integration (real HTTP calls)
âœ“ Cross-browser compatibility
âœ— Individual unit logic (slower to debug)
âœ— Exact error messages (higher level)

Example: Create Task Feature

Unit Test (taskValidators.test.ts):
  it("should reject title < 3 chars", () => {
    expect(() => CreateTaskSchema.parse({title: "ab"}))
      .toThrow("too short");
  });

Integration Test (mutations.test.ts):
  it("should create task and log activity", async () => {
    const task = await createTask({...validInput});
    const activity = await getActivity(task._id);
    expect(activity.type).toBe("task_created");
  });

E2E Test (task-management.spec.ts):
  test("should create task via UI", async ({ page }) => {
    await page.locator('button:has-text("New Task")').click();
    await page.locator('input').fill("Test Task");
    await page.locator('button:has-text("Create")').click();
    // Modal closes, task appears in Kanban
    await expect(page.locator('text=Test Task')).toBeVisible();
  });

All three are needed because:
- Unit alone: Tests pass, component breaks (missing dependency)
- Integration alone: Logic works, UI breaks (rendering error)
- E2E alone: Slow to run, hard to debug individual issues
```

---

## 6. Task Status State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TASK LIFECYCLE                             â”‚
â”‚              (Status Transitions)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VALID TRANSITIONS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                            â”‚
         â–¼                                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
    â”‚BACKLOG  â”‚  (Not started)                        â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                       â”‚
         â”‚                                            â”‚
    can move to:                                      â”‚
    â€¢ READY (preparation complete)                   â”‚
    â€¢ IN_PROGRESS (start working)                    â”‚
    â€¢ BLOCKED (blocker encountered)                  â”‚
         â”‚                                            â”‚
         â””â”€â”€â”€â”€â–ºREADYâ”€â”€â”€â”€â”€â”€â”€â”                          â”‚
                 â–²         â”‚                          â”‚
                 â”‚         â–¼                          â”‚
                 â”‚    IN_PROGRESS                     â”‚
                 â”‚         â”‚                          â”‚
                 â”‚    can move to:                    â”‚
                 â”‚    â€¢ BACKLOG (restart)             â”‚
                 â”‚    â€¢ REVIEW (ready for review)     â”‚
                 â”‚    â€¢ BLOCKED (blocker)             â”‚
                 â”‚         â”‚                          â”‚
                 â”‚         â”œâ”€â”€â”€â”€â–ºREVIEWâ”€â”€â”            â”‚
                 â”‚         â”‚              â–¼           â”‚
                 â”‚         â”‚          BLOCKED         â”‚
                 â”‚         â”‚              â”‚           â”‚
                 â”‚         â”‚              â”‚           â”‚
                 â”‚    can move to:        â”‚           â”‚
                 â”‚    â€¢ BACKLOG           â”‚           â”‚
                 â”‚    â€¢ IN_PROGRESS       â”‚           â”‚
                 â”‚    â€¢ DONE (approved)   â”‚           â”‚
                 â”‚         â”‚              â”‚           â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â–ºDONE    â”‚           â”‚
                 â”‚                â–²       â”‚           â”‚
                 â”‚                â”‚       â”‚           â”‚
                 â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                 â”‚                                    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


DETAILED STATE MACHINE:

START
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         BACKLOG                         â”‚
â”‚ (Task created but not started)          â”‚
â”‚                                         â”‚
â”‚ Actions available:                      â”‚
â”‚ â€¢ Edit task details                     â”‚
â”‚ â€¢ Add dependencies                      â”‚
â”‚ â€¢ Assign to agent                       â”‚
â”‚ â€¢ Move to READY or IN_PROGRESS          â”‚
â”‚ â€¢ Move to BLOCKED                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Agent ready to start
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         READY                           â”‚
â”‚ (Preparation complete, ready to work)   â”‚
â”‚                                         â”‚
â”‚ Triggered when:                         â”‚
â”‚ â€¢ Dependencies resolved                 â”‚
â”‚ â€¢ Resource allocated                    â”‚
â”‚ â€¢ Blockers removed                      â”‚
â”‚                                         â”‚
â”‚ Actions available:                      â”‚
â”‚ â€¢ Start work â†’ IN_PROGRESS              â”‚
â”‚ â€¢ Abandon â†’ BACKLOG                     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Agent starts working
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         IN_PROGRESS                     â”‚
â”‚ (Agent actively working)                â”‚
â”‚                                         â”‚
â”‚ Actions available:                      â”‚
â”‚ â€¢ Update progress (comments, activity)  â”‚
â”‚ â€¢ Request review â†’ REVIEW               â”‚
â”‚ â€¢ Pause â†’ BACKLOG                       â”‚
â”‚ â€¢ Hit blocker â†’ BLOCKED                 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚          â”‚
     â”‚ Blocker  â”‚ Work complete
     â”‚          â”‚
     â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BLOCKED    â”‚ â”‚    REVIEW    â”‚
â”‚ (Cannot      â”‚ â”‚ (Awaiting    â”‚
â”‚  continue)   â”‚ â”‚  approval)   â”‚
â”‚              â”‚ â”‚              â”‚
â”‚ Blocker:     â”‚ â”‚ Reviewer     â”‚
â”‚ â”œâ”€ Another   â”‚ â”‚ actions:     â”‚
â”‚ â”‚  task      â”‚ â”‚ â”œâ”€ Approve   â”‚
â”‚ â”œâ”€ Resource  â”‚ â”‚ â”‚  â†’ DONE    â”‚
â”‚ â”‚  issue     â”‚ â”‚ â”œâ”€ Revisions â”‚
â”‚ â”œâ”€ Bug in    â”‚ â”‚ â”‚  â†’ IN_PROG â”‚
â”‚ â”‚  dependencyâ”‚ â”‚ â”œâ”€ Reject    â”‚
â”‚ â””â”€ Waiting   â”‚ â”‚ â”‚  â†’ BACKLOG â”‚
â”‚   for info   â”‚ â”‚ â””â”€ Re-assign â”‚
â”‚              â”‚ â”‚    â†’ IN_PROG â”‚
â”‚ Resume when: â”‚ â”‚              â”‚
â”‚ â€¢ Blocker    â”‚ â”‚ Reviewer can â”‚
â”‚   resolved   â”‚ â”‚ also add     â”‚
â”‚              â”‚ â”‚ feedback via â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ comments     â”‚
       â”‚         â”‚              â”‚
       â”‚ Blocker â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ resolved       â”‚
       â”‚                â”‚ Approved
       â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         DONE                        â”‚
        â”‚ (Completed, approved)               â”‚
        â”‚                                     â”‚
        â”‚ Final state - no further changes    â”‚
        â”‚                                     â”‚
        â”‚ Data:                               â”‚
        â”‚ â€¢ Task archived                     â”‚
        â”‚ â€¢ Activity logged                   â”‚
        â”‚ â€¢ Timeline recorded                 â”‚
        â”‚ â€¢ Notifications sent                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

END


BLOCKED STATE (Detailed):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         BLOCKED (In Detail)              â”‚
â”‚                                          â”‚
â”‚ A task is blocked when something         â”‚
â”‚ prevents forward progress                â”‚
â”‚                                          â”‚
â”‚ Common blockers:                         â”‚
â”‚ â€¢ Task dependency (another task needed)  â”‚
â”‚ â€¢ Resource unavailable                   â”‚
â”‚ â€¢ Decision needed from someone           â”‚
â”‚ â€¢ Bug in related system                  â”‚
â”‚ â€¢ Waiting for external input             â”‚
â”‚                                          â”‚
â”‚ Resolution:                              â”‚
â”‚ 1. Root cause identified                 â”‚
â”‚ 2. Blocker resolved (dependency done)    â”‚
â”‚ 3. Status moved back to READY/IN_PROGRESSâ”‚
â”‚ 4. Activity logged                       â”‚
â”‚                                          â”‚
â”‚ Can transition to:                       â”‚
â”‚ â€¢ READY (blocker resolved)               â”‚
â”‚ â€¢ IN_PROGRESS (continue from pause)      â”‚
â”‚ â€¢ BACKLOG (abandon task)                 â”‚
â”‚ â€¢ DONE (if blocker irrelevant/approval)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


INVALID TRANSITIONS (Blocked by System):

âŒ BACKLOG â†’ DONE
   Not allowed! Must go through REVIEW

âŒ REVIEW â†’ REVIEW
   Already in review, can't re-review

âŒ BLOCKED â†’ DONE
   Can't complete blocked task
   (must resolve blocker first)

âŒ DONE â†’ anything
   Done is final state
   (would need to create new task for new work)


VALIDATION IN CODE:

lib/constants/taskTransitions.ts:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export const ALLOWED_TRANSITIONS = {
  [TASK_STATUS.BACKLOG]: [
    TASK_STATUS.READY,
    TASK_STATUS.IN_PROGRESS,
    TASK_STATUS.BLOCKED,
  ],
  [TASK_STATUS.READY]: [
    TASK_STATUS.BACKLOG,
    TASK_STATUS.IN_PROGRESS,
  ],
  [TASK_STATUS.IN_PROGRESS]: [
    TASK_STATUS.BACKLOG,
    TASK_STATUS.REVIEW,
    TASK_STATUS.BLOCKED,
  ],
  [TASK_STATUS.REVIEW]: [
    TASK_STATUS.IN_PROGRESS,
    TASK_STATUS.BACKLOG,
    TASK_STATUS.DONE,
  ],
  [TASK_STATUS.BLOCKED]: [
    TASK_STATUS.READY,
    TASK_STATUS.BACKLOG,
    TASK_STATUS.IN_PROGRESS,
  ],
  [TASK_STATUS.DONE]: [], // No transitions from DONE
};

Used in mutation:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export const updateTaskStatus = mutation({
  args: { taskId, newStatus },
  handler: async (ctx, { taskId, newStatus }) => {
    const task = await ctx.db.get(taskId);

    // Validate transition is allowed
    if (!isTransitionAllowed(task.status, newStatus)) {
      throw new ConflictError(
        `Cannot transition from ${task.status} to ${newStatus}`
      );
    }

    // Apply change
    await ctx.db.patch(taskId, { status: newStatus });

    // Log activity
    await logActivity(ctx, {
      type: ACTIVITY_TYPE.TASK_STATUS_CHANGED,
      changes: { status: { from: task.status, to: newStatus } },
    });
  }
});
```

---

## Summary: All Diagrams at a Glance

| Diagram | Shows | Purpose |
|---------|-------|---------|
| **Multi-Tenant** | How businesses are isolated | Understand data security |
| **Data Flow** | Request â†’ Database â†’ UI | Understand full request cycle |
| **Components** | How pieces compose together | Understand architecture hierarchy |
| **Query Flow** | Schema â†’ Index â†’ Optimization | Understand performance |
| **Testing Pyramid** | Test distribution (80/15/5) | Understand testing strategy |
| **State Machine** | Task status transitions | Understand workflow rules |

**Key Takeaway**: These diagrams show:
- âœ“ How data flows through the system
- âœ“ How components fit together
- âœ“ How to prevent data leaks (businessId)
- âœ“ Why indexing matters (1000x faster)
- âœ“ Testing distribution for confidence
- âœ“ Allowed state transitions

